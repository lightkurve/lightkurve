
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lightkurve.correctors.cbvcorrector &#8212; Lightkurve </title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-69171-9', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">Lightkurve v2.1</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../whats-new-v2.html">
  What's new?
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../reference/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../about/index.html">
  About
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/lightkurve/lightkurve" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for lightkurve.correctors.cbvcorrector</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Defines Corrector classes that utilize Kepler/K2/TESS Cotrending Basis Vectors.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.timeseries</span> <span class="kn">import</span> <span class="n">TimeSeries</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">Quantity</span><span class="p">,</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">astropy.utils.decorators</span> <span class="kn">import</span> <span class="n">deprecated</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">PchipInterpolator</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize_scalar</span>

<span class="kn">from</span> <span class="nn">.designmatrix</span> <span class="kn">import</span> <span class="n">DesignMatrix</span><span class="p">,</span> <span class="n">DesignMatrixCollection</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">MPLSTYLE</span>
<span class="kn">from</span> <span class="nn">..lightcurve</span> <span class="kn">import</span> <span class="n">LightCurve</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">channel_to_module_output</span><span class="p">,</span> <span class="n">validate_method</span><span class="p">,</span> <span class="n">LightkurveDeprecationWarning</span>
<span class="kn">from</span> <span class="nn">..search</span> <span class="kn">import</span> <span class="n">search_lightcurve</span>
<span class="kn">from</span> <span class="nn">.regressioncorrector</span> <span class="kn">import</span> <span class="n">RegressionCorrector</span>
<span class="kn">from</span> <span class="nn">..collections</span> <span class="kn">import</span> <span class="n">LightCurveCollection</span>
<span class="kn">from</span> <span class="nn">.metrics</span> <span class="kn">import</span> <span class="n">overfit_metric_lombscargle</span><span class="p">,</span> <span class="n">underfit_metric_neighbors</span><span class="p">,</span> <span class="n">MinTargetsError</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CBVCorrector&#39;</span><span class="p">,</span> <span class="s1">&#39;CotrendingBasisVectors&#39;</span><span class="p">,</span> <span class="s1">&#39;KeplerCotrendingBasisVectors&#39;</span><span class="p">,</span>
           <span class="s1">&#39;TessCotrendingBasisVectors&#39;</span><span class="p">,</span> <span class="s1">&#39;load_kepler_cbvs&#39;</span><span class="p">,</span><span class="s1">&#39;load_tess_cbvs&#39;</span><span class="p">,</span>
           <span class="s1">&#39;download_kepler_cbvs&#39;</span><span class="p">,</span> <span class="s1">&#39;download_tess_cbvs&#39;</span><span class="p">]</span>

<span class="c1">#*******************************************************************************</span>
<span class="c1"># CBV Corrector Class</span>

<div class="viewcode-block" id="CBVCorrector"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.CBVCorrector.html#lightkurve.correctors.CBVCorrector">[docs]</a><span class="k">class</span> <span class="nc">CBVCorrector</span><span class="p">(</span><span class="n">RegressionCorrector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for removing systematics using Cotrending Basis Vectors (CBVs)</span>
<span class="sd">    from Kepler/K2/TESS.</span>

<span class="sd">    On construction of this object, the relevant CBVs will be downloaded from</span>
<span class="sd">    MAST appropriate for the lightcurve object passed to the constructor.</span>

<span class="sd">    For TESS there are multiple CBV types. All are loaded and the user must</span>
<span class="sd">    specify which to use in the correction.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lc  : LightCurve</span>
<span class="sd">        The light curve loaded into CBVCorrector in electrons / second</span>
<span class="sd">    cbvs : CotrendingBasisVectors list</span>
<span class="sd">        The retrieved CBVs, can contain multiple types of CBVs</span>
<span class="sd">    interpolated_cbvs : bool</span>
<span class="sd">        If true then the CBVs have been interpolated to the lightcurve</span>
<span class="sd">    cbv_design_matrix : DesignMatrix</span>
<span class="sd">        The retrieved CBVs ported into a DesignMatrix object</span>
<span class="sd">    extra_design_matrix : DesignMatrix</span>
<span class="sd">        An extra design matrix to include in the fit with the CBVs</span>
<span class="sd">    design_matrix_collection : DesignMatrixCollection</span>
<span class="sd">        The design matrix collection composed of cbv_design_matrix and extra_design_matrix</span>
<span class="sd">    corrected_lc : LightCurve</span>
<span class="sd">        The returned light curve from correct() in electrons / second</span>
<span class="sd">    coefficients : float ndarray</span>
<span class="sd">        The fit coefficients corresponding to the design_matrix_collection</span>
<span class="sd">    coefficients_err : float ndarray</span>
<span class="sd">        The error estimates for the coefficients, see regressioncorrector</span>
<span class="sd">    model_lc : LightCurve</span>
<span class="sd">        The model fit to the lightcurve &#39;lc&#39;</span>
<span class="sd">    diagnostic_lightcurves : dict</span>
<span class="sd">        Model fits for each of the sub design matrices fit in model_lc</span>
<span class="sd">    lc_neighborhood : LightCurveCollection</span>
<span class="sd">        SPOC SAP light curves of all targets within the defined neighborhood of the</span>
<span class="sd">        target under study for use with the under-fitting metric</span>
<span class="sd">    lc_neighborhood_flux : list of arrays</span>
<span class="sd">        Neighboring target flux aligned or interpolated to the target under</span>
<span class="sd">        study cadence</span>
<span class="sd">    cadence_mask : np.ndarray of bool</span>
<span class="sd">        Mask, where True indicates a cadence that was used in</span>
<span class="sd">        RegressionCorrector.correct.</span>
<span class="sd">        Note: The saved cadence_mask is overwritten for each call to correct().</span>
<span class="sd">    over_fitting_score : float</span>
<span class="sd">        Over-fitting score from the most recent run of correct()</span>
<span class="sd">    under_fitting_score : float</span>
<span class="sd">        Under-fitting score from the most recent run of correct()</span>
<span class="sd">    alpha : float</span>
<span class="sd">        L2-norm regularization term used in most recent fit</span>
<span class="sd">        Equivalent to: designmatrix prior sigma = np.median(self.lc.flux_err) / np.sqrt(alpha)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CBVCorrector.__init__"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.CBVCorrector.html#lightkurve.correctors.CBVCorrector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">interpolate_cbvs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extrapolate_cbvs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_not_load_cbvs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cbv_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        This constructor will retrieve all relevant CBVs from MAST and then</span>
<span class="sd">        align or interpolate them with the passed-in light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc  : LightCurve</span>
<span class="sd">            The light curve to correct</span>
<span class="sd">        interpolate_cbvs : bool</span>
<span class="sd">            By default, the cbvs will be &#39;aligned&#39; to the lightcurve. If you</span>
<span class="sd">            wish to interpolate the cbvs instead then set this to True.</span>
<span class="sd">            Uses Piecewise Cubic Hermite Interpolating Polynomial (PCHIP). </span>
<span class="sd">        extrapolate_cbvs : bool</span>
<span class="sd">            Set to True if the CBVs also have to be extrapolated outside their time </span>
<span class="sd">            stamp range. (If False then those cadences are filled with NaNs.)</span>
<span class="sd">        do_not_load_cbvs : bool</span>
<span class="sd">            If True then the CBVs will NOT be loaded from MAST. </span>
<span class="sd">            Use this option if you wish to use the CBV corrector methods with only a </span>
<span class="sd">            custom design matrix (via the ext_dm argument in the corrector methods)</span>
<span class="sd">        cbv_dir : str</span>
<span class="sd">            Path to specific directory holding TESS CBVs. If this is None, will query</span>
<span class="sd">            MAST by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">LightCurve</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&lt;lc&gt; must be a LightCurve class&#39;</span><span class="p">)</span>

        <span class="k">assert</span>  <span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="o">==</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;electron / second&#39;</span><span class="p">),</span> \
            <span class="s1">&#39;cbvCorrector expects light curve to be passed in e-/s units.&#39;</span>        

        <span class="k">if</span> <span class="n">extrapolate_cbvs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extrapolate_cbvs</span> <span class="o">!=</span> <span class="n">interpolate_cbvs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;interpolate_cbvs must be True if extrapolate_cbvs is True&#39;</span><span class="p">)</span>

        <span class="c1"># We do not want any NaNs</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">remove_nans</span><span class="p">()</span>

        <span class="c1"># Call the RegresssionCorrector Constructor</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBVCorrector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>

        <span class="c1">#***</span>
        <span class="c1"># Retrieve all relevant CBVs from either MAST or a local directory</span>
        <span class="n">cbvs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">do_not_load_cbvs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">:</span>
                <span class="n">cbvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_kepler_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="n">cbv_dir</span><span class="p">,</span><span class="n">mission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span><span class="p">,</span> <span class="n">quarter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span>
                        <span class="n">channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">channel</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">:</span>
                <span class="n">cbvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_kepler_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="n">cbv_dir</span><span class="p">,</span><span class="n">mission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span><span class="p">,</span> <span class="n">campaign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">campaign</span><span class="p">,</span>
                        <span class="n">channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">channel</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">:</span>
                <span class="c1"># For TESS we load multiple CBV types</span>
                <span class="c1"># Single-Scale</span>
                <span class="n">cbvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_tess_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="n">cbv_dir</span><span class="p">,</span><span class="n">sector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span>
                    <span class="n">camera</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">))</span>
            
                <span class="c1"># Multi-Scale</span>
                <span class="c1"># Although there has always been 3 bands, there could be more,</span>
                <span class="c1"># continue to load more bands until no more are left to load</span>
                <span class="n">iBand</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">moreData</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">while</span> <span class="n">moreData</span><span class="p">:</span>
                    <span class="n">iBand</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cbvObj</span> <span class="o">=</span> <span class="n">load_tess_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="n">cbv_dir</span><span class="p">,</span><span class="n">sector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span>
                        <span class="n">camera</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;MultiScale&#39;</span><span class="p">,</span>
                        <span class="n">band</span><span class="o">=</span><span class="n">iBand</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cbvObj</span><span class="o">.</span><span class="n">band</span> <span class="o">==</span> <span class="n">iBand</span><span class="p">):</span>
                        <span class="n">cbvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbvObj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">moreData</span> <span class="o">=</span> <span class="kc">False</span>
            
                <span class="c1"># Spike</span>
                <span class="n">cbvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_tess_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="n">cbv_dir</span><span class="p">,</span><span class="n">sector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span>
                    <span class="n">camera</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;Spike&#39;</span><span class="p">))</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown mission type&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbvs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">CotrendingBasisVectors</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CBVs could not be loaded. CBVCorrector must exit&#39;</span><span class="p">)</span>

            <span class="c1"># Set the CBV time format units to the lightcurve time format units</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbvs</span><span class="p">)):</span>
                <span class="c1"># astropy.time.Time makes this easy!</span>
                <span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">format</span>
            
            <span class="c1"># Align or interpolate the CBVs with the lightcurve flux using the cadence numbers</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbvs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">interpolate_cbvs</span><span class="p">:</span>
                    <span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate_cbvs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbvs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cbvs</span> <span class="o">=</span> <span class="n">cbvs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolated_cbvs</span> <span class="o">=</span> <span class="n">interpolate_cbvs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extrapolated_cbvs</span> <span class="o">=</span> <span class="n">extrapolate_cbvs</span>

        <span class="c1"># Initialize all extra attributes to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_design_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_lc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_lightcurves</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc_neighborhood</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc_neighborhood_flux</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cadence_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">correct_gaussian_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">],</span>
            <span class="n">cbv_indices</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)],</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cadence_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs the correction using RegressionCorrector methods.</span>

<span class="sd">        This method will assemble the full design matrix collection composed of</span>
<span class="sd">        cbv_design_matrix and extra_design_matrix (ext_dm). It then uses the</span>
<span class="sd">        alpha L2-Norm (Ridge Regression) penalty term to set the width on the</span>
<span class="sd">        design matrix priors.  Then uses the super-class</span>
<span class="sd">        RegressionCorrector.correct to perform the correction.</span>

<span class="sd">        The relation between the L2-Norm alpha term and the Gaussian prior sigma</span>
<span class="sd">        is: </span>
<span class="sd">        alpha = flux_sigma^2 / sigma^2</span>

<span class="sd">        By default this method will use the first 8 &quot;SingleScale&quot; basis vectors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_type : str list</span>
<span class="sd">            List of CBV types to use</span>
<span class="sd">        cbv_indices : list of lists</span>
<span class="sd">            List of CBV vectors to use in each passed cbv_type. {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">            NOTE: 1-Based indexing!</span>
<span class="sd">        alpha : float</span>
<span class="sd">            L2-norm regularization penatly term. Default = 1e-20</span>
<span class="sd">            {0 =&gt; no regularization}</span>
<span class="sd">        ext_dm  :  `.DesignMatrix` or `.DesignMatrixCollection`</span>
<span class="sd">            Optionally pass an extra design matrix to also be used in the fit</span>
<span class="sd">        cadence_mask : np.ndarray of bools (optional)</span>
<span class="sd">            Mask, where True indicates a cadence that should be used.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to</span>
<span class="sd">            `RegressionCorrector.correct`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `.LightCurve`</span>
<span class="sd">            Corrected light curve, with noise removed. In units of electrons / second</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        The following example will perform the correction using the</span>
<span class="sd">        SingleScale and Spike basis vectors with a weak regularization alpha</span>
<span class="sd">        term of 0.1. It also adds in an external design matrix to perfomr a</span>
<span class="sd">        joint fit.</span>
<span class="sd">            &gt;&gt;&gt; cbv_type = [&#39;SingleScale&#39;, &#39;Spike&#39;]</span>
<span class="sd">            &gt;&gt;&gt; cbv_indices = [np.arange(1,9), &#39;ALL&#39;]</span>
<span class="sd">            &gt;&gt;&gt; corrected_lc = cbvCorrector.correct_gaussian_prior(cbv_type=cbv_type, # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt;     cbv_indices=cbv_indices, alpha=0.1, # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt;     ext_dm=design_matrix ) # doctest: +SKIP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Perform all the preparatory stuff common to all correct methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_correct_initialization</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span>
                <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">ext_dm</span><span class="p">)</span>

        <span class="c1"># Add in a width to the Gaussian priors</span>
        <span class="c1"># alpha = flux_sigma^2 / sigma^2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_prior_width</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
            
        <span class="c1"># Use RegressionCorrector.correct for the actual fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_regressioncorrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span><span class="p">,</span> 
                <span class="n">cadence_mask</span><span class="o">=</span><span class="n">cadence_mask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span>

    <span class="k">def</span> <span class="nf">correct_elasticnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cadence_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs the correction using scikit-learn&#39;s ElasticNet which</span>
<span class="sd">        utilizes combined L1- and L2-Norm priors as a regularizer.</span>

<span class="sd">        This method will assemble the full design matrix collection composed of</span>
<span class="sd">        cbv_design_matrix and extra_design_matrix (ext_dm). Then uses</span>
<span class="sd">        scikit-learn.linear_model.ElasticNet to perform the correction.</span>

<span class="sd">        By default this method will use the first 8 &quot;SingleScale&quot; basis vectors.</span>

<span class="sd">        This method will preserve the median value of the light curve flux.</span>

<span class="sd">        Note that the alpha term in scikit-learn&#39;s ElasticNet does not have the</span>
<span class="sd">        same scaling as when used in CBVCorrector.correct_gaussian_prior or </span>
<span class="sd">        CBVCorrector.correct. Do not assume similar results with a</span>
<span class="sd">        similar alpha value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_type : str list</span>
<span class="sd">            List of CBV types to use</span>
<span class="sd">        cbv_indices : list of lists</span>
<span class="sd">            List of CBV vectors to use in each passed cbv_type. {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">            NOTE: 1-Based indexing!</span>
<span class="sd">        alpha : float</span>
<span class="sd">            L2-norm regularization pentaly term.</span>
<span class="sd">            {0 =&gt; no regularization}</span>
<span class="sd">        l1_ratio : float</span>
<span class="sd">            Elastic-Net mixing parameter</span>
<span class="sd">            l1_ratio = 0 =&gt; L2 penalty (Ridge). l1_ratio = 1 =&gt; L1 penalty (Lasso).</span>
<span class="sd">        ext_dm  :  `.DesignMatrix` or `.DesignMatrixCollection`</span>
<span class="sd">            Optionally pass an extra design matrix to also be used in the fit</span>
<span class="sd">        cadence_mask : np.ndarray of bools (optional)</span>
<span class="sd">            Mask, where True indicates a cadence that should be used.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to</span>
<span class="sd">            `sklearn.linear_model.ElasticNet`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `.LightCurve`</span>
<span class="sd">            Corrected light curve, with noise removed. In units of electrons / second</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        The following example will perform the ElasticNet correction using the</span>
<span class="sd">        SingleScale and Spike basis vectors with a strong regualrization alpha</span>
<span class="sd">        term of 1.0 and an L1 ratio of 0.9 which means predominantly a Lasso</span>
<span class="sd">        regularization but with a slight amount of Ridge Regression.</span>
<span class="sd">            &gt;&gt;&gt; cbv_type = [&#39;SingleScale&#39;, &#39;Spike&#39;]</span>
<span class="sd">            &gt;&gt;&gt; cbv_indices = [np.arange(1,9), &#39;ALL&#39;]</span>
<span class="sd">            &gt;&gt;&gt; corrected_lc = cbvCorrector.correct_elasticnet(cbv_type=cbv_type, # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt;     cbv_indices=cbv_indices, alpha=1.0, l1_ratio=0.9) # doctest: +SKIP</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Perform all the preparatory stuff common to all correct methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_correct_initialization</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span>
                <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">ext_dm</span><span class="p">)</span>

        <span class="c1"># Default cadence mask</span>
        <span class="k">if</span> <span class="n">cadence_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cadence_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Use Scikit-learn ElasticNet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">ElasticNet</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span>
                <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span>

        <span class="c1"># Set mask</span>
        <span class="c1"># note: ElasticNet has no internal way to do this so we have to just</span>
        <span class="c1"># remove the cadences from X and y</span>
        <span class="n">XMasked</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">yMasked</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">XMasked</span> <span class="o">=</span> <span class="n">XMasked</span><span class="p">[</span><span class="n">cadence_mask</span><span class="p">,:]</span>
        <span class="n">yMasked</span> <span class="o">=</span> <span class="n">yMasked</span><span class="p">[</span><span class="n">cadence_mask</span><span class="p">]</span>

        <span class="c1"># Perform the ElasticNet fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XMasked</span><span class="p">,</span> <span class="n">yMasked</span><span class="p">)</span>

        <span class="c1"># Finishing work</span>
        <span class="c1"># When creating the model do not include the constant</span>
        <span class="n">model_flux</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">model_flux</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">model_flux</span><span class="p">)</span>
        <span class="c1"># TODO: Propagation of uncertainties. They really do not change much.</span>
        <span class="n">model_err</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_flux</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model_lc</span> <span class="o">=</span> <span class="n">LightCurve</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="n">model_flux</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
                <span class="n">flux_err</span><span class="o">=</span><span class="n">model_err</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_lc</span><span class="o">.</span><span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux_err</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">model_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_lightcurves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_diagnostic_lightcurves</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cadence_mask</span> <span class="o">=</span> <span class="n">cadence_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span>

<div class="viewcode-block" id="CBVCorrector.correct"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.CBVCorrector.correct.html#lightkurve.correctors.CBVCorrector.correct">[docs]</a>    <span class="k">def</span> <span class="nf">correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">],</span>
            <span class="n">cbv_indices</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)],</span> 
            <span class="n">ext_dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cadence_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-4</span><span class="p">,</span><span class="mf">1e4</span><span class="p">],</span> 
            <span class="n">target_over_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">target_under_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Optimizes the correction by adjusting the L2-Norm (Ridge Regression)</span>
<span class="sd">        regularization penalty term, alpha, based on the introduced noise</span>
<span class="sd">        (over-fitting) and residual correlation (under-fitting) goodness</span>
<span class="sd">        metrics. The numercial optimization is performed using the</span>
<span class="sd">        scipy.optimize.minimize_scalar Brent&#39;s method.</span>

<span class="sd">        The optimizer attempts to maximize the over- and under-fitting goodness</span>
<span class="sd">        metrics.  However, once the target_over_score or target_under_score is</span>
<span class="sd">        reached, a &quot;Leaky ReLU&quot; is used so that the optimization &quot;pressure&quot;</span>
<span class="sd">        concentrates on the other metric until both metrics rise above their</span>
<span class="sd">        respective target scores, instead of driving a single metric to near</span>
<span class="sd">        1.0.</span>

<span class="sd">        The optimization parameters used are stored in self.optimization_params</span>
<span class="sd">        as a record of how the optimization was performed.</span>

<span class="sd">        The optimized correction is performed using LightKurve&#39;s </span>
<span class="sd">        RegressionCorrector methods. See correct_gaussian_prior for details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_type : str list</span>
<span class="sd">            List of CBV types to use in correction {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">        cbv_indices : list of lists</span>
<span class="sd">            List of CBV vectors to use in each of cbv_type passed. {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">            NOTE: 1-Based indexing!</span>
<span class="sd">        ext_dm  :  `.DesignMatrix` or `.DesignMatrixCollection`</span>
<span class="sd">            Optionally pass an extra design matrix to also be used in the fit</span>
<span class="sd">        cadence_mask : np.ndarray of bools (optional)</span>
<span class="sd">            Mask, where True indicates a cadence that should be used.</span>
<span class="sd">        alpha_bounds : float list(len=2)</span>
<span class="sd">            upper anbd lowe bounds for alpha</span>
<span class="sd">        target_over_score : float</span>
<span class="sd">            Target Over-fitting metric score</span>
<span class="sd">        target_under_score : float</span>
<span class="sd">            Target under-fitting metric score</span>
<span class="sd">        max_iter : int</span>
<span class="sd">            Maximum number of iterations to optimize goodness metrics</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `.LightCurve`</span>
<span class="sd">            Corrected light curve, with noise removed. In units of electrons / second</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        The following example will perform the correction using the</span>
<span class="sd">        SingleScale and Spike basis vectors. It will use alpha bounds of</span>
<span class="sd">        [1.0,1e3]. The target over-fitting score is 0.5 and the target</span>
<span class="sd">        under-fitting score is 0.8.</span>

<span class="sd">            &gt;&gt;&gt; cbv_type = [&#39;SingleScale&#39;, &#39;Spike&#39;]</span>
<span class="sd">            &gt;&gt;&gt; cbv_indices = [np.arange(1,9), &#39;ALL&#39;]</span>
<span class="sd">            &gt;&gt;&gt; cbvCorrector.correct(cbv_type=cbv_type, cbv_indices=cbv_indices,  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt;     alpha_bounds=[1.0,1e3],  # doctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt;     target_over_score=0.5, target_under_score=0.8) # doctest: +SKIP</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Perform all the preparatory stuff common to all correct methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_correct_initialization</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span>
                <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">ext_dm</span><span class="p">)</span>

        <span class="c1"># Create a dictionary for optimization parameters to easily pass to the</span>
        <span class="c1"># objective function, and also to save for posterity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alpha_bounds&#39;</span><span class="p">:</span> <span class="n">alpha_bounds</span><span class="p">,</span>
                                    <span class="s1">&#39;target_over_score&#39;</span><span class="p">:</span> <span class="n">target_over_score</span><span class="p">,</span>
                                    <span class="s1">&#39;target_under_score&#39;</span><span class="p">:</span> <span class="n">target_under_score</span><span class="p">,</span>
                                    <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="n">max_iter</span><span class="p">,</span>
                                    <span class="s1">&#39;cadence_mask&#39;</span><span class="p">:</span> <span class="n">cadence_mask</span><span class="p">,</span>
                                    <span class="s1">&#39;over_metric_nSamples&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="c1">#***</span>
        <span class="c1"># Use scipy.optimize.minimize_scalar</span>
        <span class="c1"># Minimize the introduced metric</span>
        <span class="n">minimize_result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_goodness_metric_obj_fun</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Bounded&#39;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">alpha_bounds</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="n">max_iter</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># Re-fit with final alpha value</span>
        <span class="c1"># (scipy.optimize.minimize_scalar does not exit with the final fit!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_goodness_metric_obj_fun</span><span class="p">(</span><span class="n">minimize_result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Only display over- or under-fitting scores if requested to optimize</span>
        <span class="c1"># for each</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimized Over-fitting metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_score</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_score</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimized Under-fitting metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_score</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_score</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">minimize_result</span><span class="o">.</span><span class="n">x</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimized Alpha: </span><span class="si">{0:2.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span></div>

    <span class="k">def</span> <span class="nf">correct_regressioncorrector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_matrix_collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Pass-through method to gain access to the superclass </span>
<span class="sd">        RegressionCorrector.correct() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># All this does is call the superclass &#39;correct&#39; method as pass the</span>
        <span class="c1"># input arguments.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CBVCorrector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">design_matrix_collection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">over_fitting_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes the over-fitting metric using </span>
<span class="sd">        metrics.overfit_metric_lombscargle</span>

<span class="sd">        See that function for a description of the algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_samples : int</span>
<span class="sd">            The number of times to compute and average the metric</span>
<span class="sd">            This can stabalize the value, defaut = 10</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        over_fitting_metric : float</span>
<span class="sd">            A float in the range [0,1] where 0 =&gt; Bad, 1 =&gt; Good</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if corrected_lc is present</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;A corrected light curve does not exist, please run &#39;</span>
                    <span class="s1">&#39;correct first&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Ignore masked cadences</span>
        <span class="n">orig_lc</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">orig_lc</span>         <span class="o">=</span> <span class="n">orig_lc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cadence_mask</span><span class="p">]</span>
        <span class="n">corrected_lc</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">corrected_lc</span>    <span class="o">=</span> <span class="n">corrected_lc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cadence_mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">overfit_metric_lombscargle</span> <span class="p">(</span><span class="n">orig_lc</span><span class="p">,</span> <span class="n">corrected_lc</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">under_fitting_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">min_targets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">max_targets</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Computes the under-fitting metric using </span>
<span class="sd">        metrics.underfit_metric_neighbors</span>

<span class="sd">        See that function for a description of the algorithm.</span>

<span class="sd">        For TESS, the default radius is 5000 arcseconds.</span>
<span class="sd">        For Kepler/K2, the default radius is 1000 arcseconds</span>

<span class="sd">        This function will begin with the given radius in arcseconds and</span>
<span class="sd">        finds all neighboring targets. If not enough were found (&lt; min_targets)</span>
<span class="sd">        the radius is increased until a minimum number are found.</span>

<span class="sd">        The downloaded neighboring targets will be &quot;aligned&quot; to the</span>
<span class="sd">        corrected_lc, meaning the cadence numbers are used to align the targets</span>
<span class="sd">        to the corrected_lc. However, if the CBVCorrector object was</span>
<span class="sd">        instantiated with interpolated_cbvs=True then the targets will be</span>
<span class="sd">        interpolated to the corrected_lc cadence times.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radius : float</span>
<span class="sd">            Search radius to find neighboring targets in arcseconds</span>
<span class="sd">        min_targets : float</span>
<span class="sd">            Minimum number of targets to use in correlation metric</span>
<span class="sd">            Using too few can cause unreliable results. Default = 30</span>
<span class="sd">        max_targets : float</span>
<span class="sd">            Maximum number of targets to use in correlation metric</span>
<span class="sd">            Using too many can slow down the metric due to large data</span>
<span class="sd">            download. Default = 50</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        under_fitting_metric : float</span>
<span class="sd">            A float in the range [0,1] where 0 =&gt; Bad, 1 =&gt; Good</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if corrected_lc is present</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;A corrected light curve does not exist, please run &#39;</span>
                    <span class="s1">&#39;correct first&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Set default radius if one is not provided.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">):</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="n">interpolate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolated_cbvs</span>
        <span class="n">extrapolate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolated_cbvs</span>

        <span class="c1"># Make a copy of radius because it changes locally</span>
        <span class="n">dynamic_search_radius</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="c1"># Max search radius is the diagonal distance along a CCD in arcseconds</span>
        <span class="c1"># 1 pixel in TESS is 21.09 arcseconds</span>
        <span class="c1"># 1 pixel in Kepler/K2 is 3.98 arcseconds</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">):</span>
            <span class="c1"># 24 degrees of a TESS CCD array (2 CCD&#39;s wide) is 86,400 arcseconds</span>
            <span class="n">max_search_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">86400</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">):</span>
            <span class="c1"># One Kepler CCD spans 4,096 arcseconds</span>
            <span class="n">max_search_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4096</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown mission&#39;</span><span class="p">)</span>

        <span class="c1"># Ignore masked cadences</span>
        <span class="n">corrected_lc</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">corrected_lc</span>    <span class="o">=</span> <span class="n">corrected_lc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cadence_mask</span><span class="p">]</span>
        
        <span class="c1"># Dynamically increase radius until min_targets reached.</span>
        <span class="n">continue_searching</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">continue_searching</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">underfit_metric_neighbors</span> <span class="p">(</span><span class="n">corrected_lc</span><span class="p">,</span> 
                            <span class="n">dynamic_search_radius</span><span class="p">,</span> <span class="n">min_targets</span><span class="p">,</span> <span class="n">max_targets</span><span class="p">,</span> 
                            <span class="n">interpolate</span><span class="p">,</span> <span class="n">extrapolate</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MinTargetsError</span><span class="p">:</span>
                <span class="c1"># Too few targets found, try increasing search radius</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_search_radius</span> <span class="o">&gt;</span> <span class="n">max_search_radius</span><span class="p">):</span>
                    <span class="c1"># Hit the edge of the CCD, we have to give up</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not enough neighboring targets were &#39;</span>
                        <span class="s1">&#39;found. under_fitting_metric failed&#39;</span><span class="p">)</span>
                <span class="c1"># Too few found, increase search radius</span>
                <span class="n">dynamic_search_radius</span> <span class="o">*=</span> <span class="mf">1.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">continue_searching</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">metric</span>

    <span class="k">def</span> <span class="nf">_correct_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span>
            <span class="n">ext_dm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs all the preparatory work needed before applying a &#39;correct&#39;</span>
<span class="sd">        method.</span>

<span class="sd">        This helper function is used so that multiple correct methods can be used</span>
<span class="sd">        without the need to repeat preparatory code.</span>

<span class="sd">        The main thing this method does is set up the design matrix, given the</span>
<span class="sd">        requested CBVs and external design matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_type : str list</span>
<span class="sd">            List of CBV types to use</span>
<span class="sd">            Can be None if only ext_dm is used</span>
<span class="sd">        cbv_indices : list of lists</span>
<span class="sd">            List of CBV vectors to use in each passed cbv_type. {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">            Can be None if only ext_dm is used</span>
<span class="sd">        ext_dm  :  `.DesignMatrix` or `.DesignMatrixCollection`</span>
<span class="sd">            Optionally pass an extra design matrix to additionally be used in the fit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="p">((</span><span class="n">cbv_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">cbv_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)),</span> \
                <span class="s1">&#39;Both cbv_type and cbv_indices must be None, or neither&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cbv_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cbv_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">use_cbvs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_cbvs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If any DesignMatrix was passed then store it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_design_matrix</span> <span class="o">=</span> <span class="n">ext_dm</span>
        <span class="c1"># Check that extra design matrix is aligned with lc flux</span>
        <span class="k">if</span> <span class="n">ext_dm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext_dm</span><span class="p">,</span> <span class="n">DesignMatrix</span><span class="p">),</span> \
                <span class="s1">&#39;ext_dm must be a DesignMatrix&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ext_dm</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;ext_dm must contain the same number of cadences as lc.flux&#39;</span><span class="p">)</span>
            

        <span class="c1"># Create a CBV design matrix for each CBV set requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">use_cbvs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> 
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)),</span> \
                    <span class="s1">&#39;cbv_type and cbv_indices must be lists of strings&#39;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Kepler&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">]):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">,</span> \
                    <span class="s1">&#39;cbv_type must be only Single-Scale for Kepler and K2 missions&#39;</span>
                <span class="k">assert</span> <span class="n">cbv_type</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">],</span> \
                    <span class="s1">&#39;cbv_type must be Single-Scale for Kepler and K2 missions&#39;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">),</span> \
                    <span class="s1">&#39;Multiple CBV types are only allowed for TESS&#39;</span>
            
            <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">)),</span> \
                <span class="s1">&#39;cbv_type and cbv_indices must be the same list length&#39;</span>


            <span class="c1"># Loop through all the stored CBVs and find the ones matching the</span>
            <span class="c1"># requested cbv_type list</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">)):</span> 
                <span class="k">for</span> <span class="n">cbvs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbvs</span><span class="p">:</span>
            
                    <span class="c1"># Temporarily copy the cbv_indices requested</span>
                    <span class="n">cbv_idx_loop</span> <span class="o">=</span> <span class="n">cbv_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
                    <span class="c1"># If requesting &#39;ALL&#39; CBVs then set to max default number</span>
                    <span class="c1"># Remember, cbv indices is 1-based!</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_idx_loop</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cbv_idx_loop</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)):</span>
                        <span class="n">cbv_idx_loop</span> <span class="o">=</span> <span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_indices</span>
                    <span class="c1"># Trim to nCBVs in cbvs</span>
                    <span class="n">cbv_idx_loop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cbv_idx_loop</span> <span class="k">if</span>
                        <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">))])</span>
            
                    <span class="k">if</span> <span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MultiScale&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Find the correct band if this is a multi-scale CBV set</span>
                        <span class="n">band</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_type</span> <span class="ow">in</span> <span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cbvs</span><span class="o">.</span><span class="n">band</span> <span class="o">==</span> <span class="n">band</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">to_designmatrix</span><span class="p">(</span>
                                <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_idx_loop</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_type</span> <span class="ow">in</span> <span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">to_designmatrix</span><span class="p">(</span>
                                <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_idx_loop</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>

        <span class="c1">#***</span>
        <span class="c1"># Create the design matrix collection with CBVs, plus extra passed basis vectors</span>

        <span class="c1"># Create the full design matrix collection from all the sub-design</span>
        <span class="c1"># matrices (I.e &#39;flatten&#39; the design matrix collection)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_design_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># Combine cbv_design_matrix and extra_design_matrix </span>
            <span class="n">dm_to_flatten</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cbv_dm</span> <span class="k">for</span> <span class="n">cbv_dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span><span class="p">],</span> 
                                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_design_matrix</span><span class="p">]]</span>
            <span class="n">flattened_dm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">dm_to_flatten</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># Just use cbv_design_matrix </span>
            <span class="n">dm_to_flatten</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cbv_dm</span> <span class="k">for</span> <span class="n">cbv_dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_design_matrix</span><span class="p">]]</span>
            <span class="n">flattened_dm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">dm_to_flatten</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Just use extra_design_matrix</span>
            <span class="n">flattened_dm_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_design_matrix</span><span class="p">]</span>

        <span class="c1"># Add in a constant to the design matrix collection</span>
        <span class="c1"># Note: correct_elasticnet ASSUMES the the last vector in the</span>
        <span class="c1"># design_matrix_collection is the constant</span>
        <span class="n">flattened_dm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DesignMatrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">flattened_dm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Constant&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Constant&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span> <span class="o">=</span> <span class="n">DesignMatrixCollection</span><span class="p">(</span><span class="n">flattened_dm_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_prior_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the Gaussian prior in the design_matrix_collection widths to sigma</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigma : scalar float </span>
<span class="sd">            all widths are set to the same value</span>
<span class="sd">            If sigma = None then uniform sigma is set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;separate widths is not yet implemented&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span><span class="p">:</span>
            <span class="n">nCBVs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">prior_sigma</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dm</span><span class="o">.</span><span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nCBVs</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dm</span><span class="o">.</span><span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nCBVs</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>


    <span class="k">def</span> <span class="nf">_goodness_metric_obj_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The objective function to minimize with</span>
<span class="sd">        scipy.optimize.minimize_scalar</span>

<span class="sd">        First sets the alpha regularization penalty then runs</span>
<span class="sd">        RegressionCorrector.correct and then computes the over- and</span>
<span class="sd">        under-fitting goodness metrics to return a scalar penalty term to</span>
<span class="sd">        minimize.</span>

<span class="sd">        Uses the paramaters in self.optimization_params.</span>

<span class="sd">        Parameters (in self.optimization_params)</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float</span>
<span class="sd">            regularization penalty term value to set</span>
<span class="sd">        cadence_mask : np.ndarray of bools (optional)</span>
<span class="sd">            Mask, where True indicates a cadence that should be used.</span>
<span class="sd">        target_over_score : float</span>
<span class="sd">            Target Over-fitting metric score</span>
<span class="sd">            If &lt;=0 then ignore over-fitting metric</span>
<span class="sd">        target_under_score : float</span>
<span class="sd">            Target under-fitting metric score</span>
<span class="sd">            If &lt;=0 then ignore under-fitting metric</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        penalty : float</span>
<span class="sd">            Penalty term for minimizer, based on goodness metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Add in a width to the Gaussian priors</span>
        <span class="c1"># alpha = flux_sigma^2 / sigma^2</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_prior_width</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>                
        <span class="c1"># Use RegressionCorrector.correct for the actual fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_regressioncorrector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix_collection</span><span class="p">,</span> 
            <span class="n">cadence_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;cadence_mask&#39;</span><span class="p">])</span>

        <span class="c1"># Do not compute and ignore if target score &lt; 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">overMetric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">(</span>
                <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;over_metric_nSamples&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">overMetric</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Do not compute and ignore if target score &lt; 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">underMetric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">underMetric</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Once we hit the target we want to ease-back on increasing the metric</span>
        <span class="c1"># However, we don&#39;t want to ease-back to zero pressure, that will</span>
        <span class="c1"># unconstrain the penalty term and cause the optmizer to run wild.</span>
        <span class="c1"># So, use a &quot;Leaky ReLU&quot;</span>
        <span class="c1"># metric&#39; = threshold + (metric - threshold) * leakFactor</span>
        <span class="n">leakFactor</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">overMetric</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]):</span>
            <span class="n">overMetric</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">leakFactor</span> <span class="o">*</span> 
                    <span class="p">(</span><span class="n">overMetric</span> <span class="o">-</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_over_score&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">underMetric</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]):</span>
            <span class="n">underMetric</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">leakFactor</span> <span class="o">*</span> 
                    <span class="p">(</span><span class="n">underMetric</span> <span class="o">-</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_params</span><span class="p">[</span><span class="s1">&#39;target_under_score&#39;</span><span class="p">]))</span>

        <span class="n">penalty</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">overMetric</span> <span class="o">+</span> <span class="n">underMetric</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">penalty</span>

<div class="viewcode-block" id="CBVCorrector.diagnose"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.CBVCorrector.diagnose.html#lightkurve.correctors.CBVCorrector.diagnose">[docs]</a>    <span class="k">def</span> <span class="nf">diagnose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns diagnostic plots to assess the most recent correction.</span>

<span class="sd">        If a correction has not yet been fitted, a ``ValueError`` will be raised.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `~matplotlib.axes.Axes`</span>
<span class="sd">            The matplotlib axes object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">axs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_plot</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Alpha = </span><span class="si">{0:2.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">axs</span></div>

    <span class="k">def</span> <span class="nf">goodness_metric_scan_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">],</span>
            <span class="n">cbv_indices</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)],</span> <span class="n">alpha_range_log10</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="n">ext_dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cadence_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a diagnostic plot of the over and under goodness metrics as a</span>
<span class="sd">        function of the L2-Norm regularization term, alpha.</span>

<span class="sd">        alpha is scanned by default to the range 10^-4 : 10^4 in logspace</span>

<span class="sd">        cbvCorrector.correct_gaussian_prior is used to make the correction for</span>
<span class="sd">        each alpha. Then the over and under goodness metric are computed.</span>

<span class="sd">        If a correction has already been performed (via one of the correct_*</span>
<span class="sd">        methods) then the used alpha value is also plotted for reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_type : str list</span>
<span class="sd">            List of CBV types to use in correction {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">        cbv_indices : list of lists</span>
<span class="sd">            List of CBV vectors to use in each of cbv_type passed. {&#39;ALL&#39; =&gt; Use all}</span>
<span class="sd">            NOTE: 1-Based indexing!</span>
<span class="sd">        alpha_range_log10 : [list of two] The start and end exponent for the logspace scan.</span>
<span class="sd">            Default = [-4, 4]</span>
<span class="sd">        ext_dm  :  `.DesignMatrix` or `.DesignMatrixCollection`</span>
<span class="sd">            Optionally pass an extra design matrix to also be used in the fit</span>
<span class="sd">        cadence_mask : np.ndarray of bools (optional)</span>
<span class="sd">            Mask, where True indicates a cadence that should be used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `~matplotlib.axes.Axes`</span>
<span class="sd">            The matplotlib axes object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">alphaArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">alpha_range_log10</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha_range_log10</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># We need to make a copy of self so that the scan&#39;s final fit parameters</span>
        <span class="c1"># do not over-write any stored fit parameters</span>
        <span class="n">cbvCorrectorCopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Compute both metrics vs. alpha</span>
        <span class="n">overMetric</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">underMetric</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">thisAlpha</span> <span class="ow">in</span> <span class="n">alphaArray</span><span class="p">:</span>
            <span class="n">cbvCorrectorCopy</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> 
                                        <span class="n">alpha</span><span class="o">=</span><span class="n">thisAlpha</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">ext_dm</span><span class="p">,</span>
                                        <span class="n">cadence_mask</span><span class="o">=</span><span class="n">cadence_mask</span><span class="p">)</span>
            <span class="n">overMetric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbvCorrectorCopy</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">underMetric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbvCorrectorCopy</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">())</span>

        <span class="c1"># plot both</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">alphaArray</span><span class="p">,</span> <span class="n">underMetric</span><span class="p">,</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UnderFit&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">alphaArray</span><span class="p">,</span> <span class="n">overMetric</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OverFit&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;corrected_lc Alpha = </span><span class="si">{0:2.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">))</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Goodness Metrics vs. L2-Norm Penalty (alpha)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regularization Factor Alpha&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Goodness Metric&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a copy of this `cbvCorrector` object.</span>

<span class="sd">        This method uses Python&#39;s `copy.deepcopy` function to ensure that all</span>
<span class="sd">        objects stored within the cbvCorrector instance are fully copied.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cbvCorrector_copy : `cbvCorrector`</span>
<span class="sd">            A new object which is a copy of the original.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This will print all attributes of the class kinda like in</span>
<span class="sd">        self.__dict__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1"> targetid=</span><span class="si">{}</span><span class="s1"> length=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">targetid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;corrected_lc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1"> targetid=</span><span class="si">{}</span><span class="s1"> length=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">targetid</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corrected_lc</span><span class="p">))</span>
        
        <span class="n">dict_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dict_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">dict_string</span></div>

<span class="c1">#*******************************************************************************</span>
<span class="c1">#*******************************************************************************</span>
<span class="c1">#*******************************************************************************</span>
<span class="c1"># Cotrending Basis Vectors Classes and Functions </span>
<span class="c1">#*******************************************************************************</span>
<span class="c1">#*******************************************************************************</span>
<span class="c1">#*******************************************************************************</span>

<span class="k">class</span> <span class="nc">CotrendingBasisVectors</span><span class="p">(</span><span class="n">TimeSeries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a CotrendingBasisVectors class, which is the Superclass for</span>
<span class="sd">    KeplerCotrendingBasisVectors and TessCotrendingBasisVectors.</span>
<span class="sd">    Normally, one would use these latter classes instead of instantiating</span>
<span class="sd">    CotrendingBasisVectors directly. However, for generating custom CBVs one can</span>
<span class="sd">    use this super class.</span>

<span class="sd">    Stores Cotrending Basis Vectors for the Kepler/K2/TESS missions.</span>

<span class="sd">    Each CotrendingBasisVectors object contains only ONE set of CBVs.</span>
<span class="sd">    Instantiate multiple objects to store multiple set of CBVS, for example, to</span>
<span class="sd">    save each of the three multi-scale bands in TESS.</span>

<span class="sd">    CotrendingBasisVectors calls the standard __init__ from</span>
<span class="sd">    astropy.timeseries.TimeSeries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : `~astropy.table.Table`</span>
<span class="sd">        Data to initialize CotrendingBasisVectors. The</span>
<span class="sd">        CBVs should be in columns called ``&#39;CADENCENO&#39;``, ``&#39;GAP&#39;``, ``&#39;VECTOR_1&#39;``,</span>
<span class="sd">        ``&#39;VECTOR_2&#39;``, ... ``&#39;VECTOR_N&#39;``</span>
<span class="sd">        If &#39;GAP&#39; is not given then it is filled with all False.</span>
<span class="sd">        If &#39;CADENCENO&#39; is not given then it is filled with np.arange(nCadences)</span>
<span class="sd">    time : `~astropy.time.Time`</span>
<span class="sd">        Time values.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional keyword arguments are passed to `~astropy.table.QTable`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cadenceno       : int array-like</span>
<span class="sd">        Cadence indices</span>
<span class="sd">    time            : flaot array-like</span>
<span class="sd">        CBV cadence times</span>
<span class="sd">    gap_indicators  : bool array-like</span>
<span class="sd">        True =&gt; cadence is gapped</span>
<span class="sd">    cbv_indices     : list int-like</span>
<span class="sd">        List of CBV indices available</span>
<span class="sd">        1-based indexing</span>
<span class="sd">    [&#39;VECTOR_#&#39;]    : astropy.table.column.Column</span>
<span class="sd">        CBV number #</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#***</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Add some columns if not existant</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;GAP&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;GAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;CADENCENO&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># Initialize the astropy.timeseries.TimeSeries attributes</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Ensure all columns are Quantity objects</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="p">(</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">Time</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replace_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>


    <span class="c1"># cbv_indices are always determined by the &#39;VECTOR_#&#39; columns in the</span>
    <span class="c1"># TimeSeries</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cbv_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VECTOR_&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">cbv_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">:]))</span>
        <span class="k">return</span> <span class="n">cbv_indices</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The time values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>

    <span class="nd">@time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gap_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GAP&#39;</span><span class="p">]</span>

    <span class="nd">@gap_indicators</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">gap_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gap_indicators</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gap_indicators</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cadenceno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">]</span>

    <span class="nd">@cadenceno</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cadenceno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cadenceno</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cadenceno</span>

    <span class="k">def</span> <span class="nf">to_designmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CBVs&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a `DesignMatrix` where the columns are the</span>
<span class="sd">        requested CBVs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_indices : list of ints</span>
<span class="sd">            List of CBV vectors to use. 1-based indexing!</span>
<span class="sd">            {&#39;all&#39; =&gt; Use all}</span>
<span class="sd">        name : str</span>
<span class="sd">            A Name for the DesignMatrix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            design_matrix : designmatrix.DesignMatrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cbv_indices</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cbv_indices must either be list of ints or &quot;all&quot;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">cbv_indices</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CBVs use 1-based indexing. Do not request CBV index &#39;0&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cbv_indices</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)):</span>
            <span class="n">cbv_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span>

        <span class="n">cbv_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cbv_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cbv_indices</span><span class="p">:</span>
            <span class="c1"># Check that the CBV index is available</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">:</span>
                <span class="c1"># If so, append it as a column to the matrix</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbv_matrix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cbv_matrix</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)])[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cbv_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cbv_matrix</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)])[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]))</span>
                <span class="n">cbv_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">DesignMatrix</span><span class="p">(</span><span class="n">cbv_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cbv_names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the requested CBVs evenly spaced out vertically for legibility.</span>

<span class="sd">        Does not plot gapped cadences</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbv_indices : list of ints</span>
<span class="sd">            The list of cotrending basis vectors to plot. For example:</span>
<span class="sd">            [1, 2] will fit the first two basis vectors. &#39;all&#39; =&gt; plot all</span>
<span class="sd">            NOTE: 1-based indexing</span>
<span class="sd">        ax : matplotlib.pyplot.Axes.AxesSubplot</span>
<span class="sd">            Matplotlib axis object. If `None`, one will be generated.</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Dictionary of arguments to be passed to `matplotlib.pyplot.plot`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax : matplotlib.pyplot.Axes.AxesSubplot</span>
<span class="sd">            Matplotlib axis object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cbv_indices</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cbv_indices must either be list of ints or &quot;all&quot;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">cbv_indices</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CBVs use 1-based indexing. Do not request CBV index &#39;0&#39;&quot;</span><span class="p">)</span>


        <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">MPLSTYLE</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cbv_indices</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)):</span>
                <span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VECTOR_&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">cbv_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">:]))</span>

            <span class="n">cbv_designmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_designmatrix</span><span class="p">(</span><span class="n">cbv_indices</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Plot gaps as NaN</span>
            <span class="n">timeArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">timeArray</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># kepler cbvs are masked arrays and do not support item assignment</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">timeArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_indicators</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># Get the CBV arrays that were requested</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cbv_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cbv_designmatrix</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">cbvIndex</span> <span class="o">=</span> <span class="n">cbv_name</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
                <span class="n">cbv</span> <span class="o">=</span> <span class="n">cbv_designmatrix</span><span class="p">[</span><span class="n">cbv_name</span><span class="p">]</span>
                <span class="c1"># Plot gaps as NaN</span>
                <span class="n">cbv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_indicators</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeArray</span><span class="p">,</span> <span class="n">cbv</span><span class="o">-</span><span class="n">idx</span><span class="o">/</span><span class="mf">10.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvIndex</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mission&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kepler CBVs (Quarter.Module.Output : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">)&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
                                 <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K2 CBVs (Campaign.Module.Output : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">)&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">campaign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
                                 <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span> <span class="o">==</span> <span class="s1">&#39;MultiScale&#39;</span><span class="p">):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TESS CBVs (Sector.Camera.CCD : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, CBVType.Band : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">)&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">),</span>
                                 <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TESS CBVs (Sector.Camera.CCD : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, CBVType : </span><span class="si">{}</span><span class="s1">)&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span><span class="p">),</span>
                                 <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is a generic CotrendingBasisVectors object</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CBVs&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aligns the CBVs to a light curve. The lightCurve object might not</span>
<span class="sd">        have the same cadences as the CBVs. This will trim the CBVs to be</span>
<span class="sd">        aligned with the light curve.</span>

<span class="sd">        This method will use the cadence number (lc.cadenceno) to</span>
<span class="sd">        perform the synchronization. Only cadence numbers that exist in both</span>
<span class="sd">        the CBVs and the light curve will have values in the returned CBVs. All</span>
<span class="sd">        cadence numbers that exist in the light curve but not in the CBVs will</span>
<span class="sd">        have NaNs returned for the CBVs on those cadences and the GAP set to</span>
<span class="sd">        True.</span>

<span class="sd">        Any cadences in the CBVs not in the light curve will be removed from the CBVs.</span>

<span class="sd">        The returned cbvs object is sorted by cadenceno.</span>

<span class="sd">        If you wish to interpolate the CBVs to arbitrary light curve cadence</span>
<span class="sd">        times then use the interpolate method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : LightCurve object</span>
<span class="sd">            The reference light curve to align to</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cbvs : CotrendingBasisVectors object</span>
<span class="sd">            Aligned to the light curve</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The fraction of cadences that do not align to throw a</span>
        <span class="c1"># warning about the CBVs being poorly aligned to the light curve</span>
        <span class="n">poorly_aligned_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">poorly_aligned_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">LightCurve</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&lt;lc&gt; must be a LightCurve class&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="s1">&#39;cadenceno&#39;</span><span class="p">):</span>

            <span class="c1"># Make a deepcopy so we do not just return a modified original</span>
            <span class="n">cbvs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># NaN any CBV cadences that are in the light curve and not in CBVs</span>
            <span class="c1"># This requires us to add rows to the CBV table</span>
            <span class="n">lc_nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">,</span> <span class="n">cbvs</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">))</span>
            <span class="c1"># Determine if the CBVs are poorly aligned to the light curve</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">lc_nan_mask</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_nan_mask</span><span class="p">))</span> <span class="o">&gt;</span>
                            <span class="n">poorly_aligned_threshold</span><span class="p">):</span>
                <span class="n">poorly_aligned_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">lc_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lc_nan_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Sadly, there is no TimesSeries.add_rows (plural), so we have to</span>
            <span class="c1"># add each row in a for-loop</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc_nan_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">lc_nan_indices</span><span class="p">:</span>
                    <span class="n">dict_to_add</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">dict_to_add</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">dict_to_add</span><span class="p">[</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">dict_to_add</span><span class="p">[</span><span class="s1">&#39;GAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">cbvIdx</span> <span class="ow">in</span> <span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">:</span>
                        <span class="n">dict_to_add</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvIdx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                    <span class="n">cbvs</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">dict_to_add</span><span class="p">)</span>

            <span class="c1"># There appears to be a bug in astropy.timeseries when using ts[x:y]</span>
            <span class="c1"># in combination with ts.remove_row() or ts.remove_rows.</span>
            <span class="c1"># See LightKurve Issue #836.</span>
            <span class="c1"># To get around the error for now, we will attempt to use</span>
            <span class="c1"># ts[x:y]. If it errors out then revert to remove_rows, which is</span>
            <span class="c1"># REALLY slow.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This method is fast but might cause errors</span>
                <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">,</span> <span class="n">lc</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Determine if the CBVs are poorly aligned to the light curve</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbvs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">poorly_aligned_threshold</span><span class="p">:</span>
                    <span class="n">poorly_aligned_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cbvs</span> <span class="o">=</span> <span class="n">cbvs</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># This method is slow but appears to be more robust</span>
                <span class="n">trim_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">,</span> <span class="n">lc</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Determine if the CBVs are poorly aligned to the light curve</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trim_indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbvs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">poorly_aligned_threshold</span><span class="p">:</span>
                    <span class="n">poorly_aligned_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cbvs</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">trim_indices</span><span class="p">)</span>

            <span class="c1"># Now sort the CBVs by cadenceno</span>
            <span class="n">cbvs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;align requires cadence numbers for the &#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;light curve. NO SYNCHRONIZATION OCCURED&#39;</span><span class="p">)</span>

        <span class="c1"># Only issue this warning once</span>
        <span class="k">if</span> <span class="n">poorly_aligned_flag</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The </span><span class="si">{}</span><span class="s1"> CBVs do not appear to be well aligned to the &#39;</span>
                <span class="s1">&#39;light curve. Consider using &quot;interpolate_cbvs=True&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvs</span><span class="o">.</span><span class="n">cbv_type</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cbvs</span>

    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpolates the CBV to the cadence times in the given light curve</span>
<span class="sd">        using Piecewise Cubic Hermite Interpolating Polynomial (PCHIP).</span>

<span class="sd">        Uses scipy.interpolate.PchipInterpolator</span>

<span class="sd">        Each CBV is interpolated independently. All gaps are set to False.</span>
<span class="sd">        The cadence numbers are taken from the light curve.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lc : LightCurve object</span>
<span class="sd">            The reference light curve cadence times to interpolate to</span>
<span class="sd">        extrapolate : bool, optional</span>
<span class="sd">            Whether to extrapolate to out-of-bounds points based on first</span>
<span class="sd">            and last intervals, or to return NaNs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cbvs_interpolated: CotrendingBasisVectors object</span>
<span class="sd">            interpolated to the light curve cadence times</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">LightCurve</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&lt;lc&gt; must be a LightCurve class&#39;</span><span class="p">)</span>

        <span class="c1"># If not extrapolating then check if extrapolation is necessary.</span>
        <span class="c1"># If so, throw a warning</span>
        <span class="k">if</span> <span class="n">extrapolate</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">gapRemovedCBVtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_indicators</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gapRemovedCBVtime</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gapRemovedCBVtime</span><span class="p">)</span>   <span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Extrapolation of CBVs appears to be necessary. &#39;</span>
                            <span class="s1">&#39;Extrapolated values will be filled with zeros. &#39;</span>
                            <span class="s1">&#39;Recommend setting extrapolate=True&#39;</span><span class="p">)</span>

        <span class="c1"># Create the new cbv object with no basis vectors, yet...</span>
        <span class="n">cbvNewTime</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Gaps are all false</span>
        <span class="n">gaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dataTbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">lc</span><span class="o">.</span><span class="n">cadenceno</span><span class="p">,</span> <span class="n">gaps</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">,</span> <span class="s1">&#39;GAP&#39;</span><span class="p">))</span>

        <span class="c1"># We are PCHIP interpolating each CBV independently.</span>
        <span class="c1"># Do not include gaps when interpolating</span>
        <span class="n">warning_posted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">:</span>
            <span class="n">fInterp</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_indicators</span><span class="o">.</span><span class="n">value</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_indicators</span><span class="o">.</span><span class="n">value</span><span class="p">)],</span> 
                    <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fInterp</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># Replace NaNs with 0.0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)]))):</span>
                <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)])]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;VECTOR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)])),</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="c1"># Only post this warning once</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">warning_posted</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Some interpolated (or extrapolated) CBV values have been set to zero&#39;</span><span class="p">)</span>
                    <span class="n">warning_posted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># We need to return a new CotrendingBasisVectors class. Make sure we</span>
        <span class="c1"># instantiate the correct type.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">KeplerCotrendingBasisVectors</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">KeplerCotrendingBasisVectors</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTbl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">cbvNewTime</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TessCotrendingBasisVectors</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">TessCotrendingBasisVectors</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTbl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">cbvNewTime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CotrendingBasisVectors</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTbl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">cbvNewTime</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">KeplerCotrendingBasisVectors</span><span class="p">(</span><span class="n">CotrendingBasisVectors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sub-class for Kepler/K2 cotrending basis vectors</span>

<span class="sd">    See CotrendingBasisVectors for class details</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    CotrendingBasisVectors attributes</span>
<span class="sd">    astropy.timeseries.TimeSeries attributes</span>
<span class="sd">    mission         : [str] (&#39;Kepler&#39;, &#39;K2&#39;)</span>
<span class="sd">    cbv_type        : [str] always &#39;SingleScale&#39;</span>
<span class="sd">    quarter         : [int] Kepler Quarter</span>
<span class="sd">    campaign        : [int] K2 Campaign</span>
<span class="sd">    module          : [int] Kepler instrument CCD module</span>
<span class="sd">    output          : [int] Kepler instrument CCD output</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#***</span>
    <span class="n">validMissionOptions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Kepler&#39;</span><span class="p">,</span> <span class="s1">&#39;K2&#39;</span><span class="p">)</span>
    <span class="n">validCBVTypes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">)</span>

    <span class="c1">#***</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates a KeplerCotrendingBasisVectors object.</span>
<span class="sd">        Normally one would use KeplerCotrendingBasisVectors.from_hdu to</span>
<span class="sd">        automatically set up the object. However, for certain functionality</span>
<span class="sd">        one must instantiate the object directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize attributes common to all CotrendingBasisVector classes</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KeplerCotrendingBasisVectors</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class method to instantiate a KeplerCotrendingBasisVectors object</span>
<span class="sd">        from a CBV FITS HDU.</span>

<span class="sd">        Kepler/K2 CBVs are all in the same FITS file for each quarter/campaign,</span>
<span class="sd">        so, when instantiating the CBV object we must specify which module and</span>
<span class="sd">        output we desire. Only Single-Scale CBVs are stored for Kepler.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdu : astropy.io.fits.hdu.hdulist.HDUList</span>
<span class="sd">            A pyfits opened FITS file containing the CBVs</span>
<span class="sd">        module : int</span>
<span class="sd">            Kepler CCD module 2 - 84</span>
<span class="sd">        output : int</span>
<span class="sd">            Kepler CCD output 1 - 4</span>
<span class="sd">        **kwargs : Optional arguments</span>
<span class="sd">            Passed to the TimeSeries superclass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">module</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">module</span> <span class="o">&lt;</span> <span class="mi">85</span><span class="p">,</span> <span class="s1">&#39;Invalid module number&#39;</span>
        <span class="k">assert</span> <span class="n">output</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">output</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Invalid output number&#39;</span>

        <span class="c1"># Get the mission: Kepler or K2</span>
        <span class="c1"># Sadly, the HDU does not explicitly say if this is Kepler or K2 CBVs.</span>
        <span class="k">if</span> <span class="s1">&#39;QUARTER&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">mission</span> <span class="o">=</span> <span class="s1">&#39;Kepler&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;CAMPAIGN&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">mission</span> <span class="o">=</span> <span class="s1">&#39;K2&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This does not appear to be a Kepler or K2 FITS HDU&#39;</span><span class="p">)</span>

        <span class="n">extName</span> <span class="o">=</span> <span class="s1">&#39;MODOUT_</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read the columns and meta data</span>
            <span class="n">dataTbl</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">extName</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;fits&quot;</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">extName</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># TimeSeries-based objects require a dedicated time column</span>
            <span class="c1"># Replace NaNs with default time &#39;2000-01-01&#39;, otherwise,</span>
            <span class="c1"># astropy.time.Time complains</span>
            <span class="n">nanHere</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;TIME_MJD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">timeData</span> <span class="o">=</span> <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;TIME_MJD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">timeData</span><span class="p">[</span><span class="n">nanHere</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">([</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
            <span class="n">cbvTime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">timeData</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s1">&#39;TIME_MJD&#39;</span><span class="p">)</span>

            <span class="c1"># Gaps are labelled as &#39;GAPFLAG&#39; so rename!</span>
            <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;GAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;GAPFLAG&#39;</span><span class="p">]</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s1">&#39;GAPFLAG&#39;</span><span class="p">)</span>

            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MISSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mission</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SingleScale&#39;</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">dataTbl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cbvTime</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Here we instantiate the actual object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTbl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">cbvTime</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MISSION&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@mission</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mission</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MISSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mission</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cbv_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@cbv_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cbv_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbv_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quarter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;QUARTER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@quarter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">quarter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quarter</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;QUARTER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quarter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CAMPAIGN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@campaign</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">campaign</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CAMPAIGN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">campaign</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MODULE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@module</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@output</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">:</span>
            <span class="n">repr_string</span> <span class="o">=</span> <span class="s1">&#39;Kepler CBVs, Quarter.Module.Output : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, nCBVs : </span><span class="si">{}</span><span class="s1">&#39;</span>\
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">:</span>
            <span class="n">repr_string</span> <span class="o">=</span> <span class="s1">&#39;K2 CBVs, Campaign.Module.Output : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, nCBVs : </span><span class="si">{}</span><span class="s1">&#39;</span>\
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">campaign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">repr_string</span>


<span class="k">class</span> <span class="nc">TessCotrendingBasisVectors</span><span class="p">(</span><span class="n">CotrendingBasisVectors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sub-class for TESS cotrending basis vectors</span>

<span class="sd">    See CotrendingBasisVectors for class details</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    CotrendingBasisVectors attributes</span>
<span class="sd">    astropy.timeseries.TimeSeries attributes</span>
<span class="sd">    mission         : [str] (&#39;TESS&#39;)</span>
<span class="sd">    cbv_type        : [str (&#39;SingleScale&#39;, &#39;MultiScale&#39;, &#39;Spike&#39;)</span>
<span class="sd">    sector          : [int] TESS Sector</span>
<span class="sd">    camera          : [int] TESS Camera Index</span>
<span class="sd">    ccd             : [int] TESS CCD Index</span>
<span class="sd">    band            : [int] MultiScale band number (invalid for other CBV types)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">validMissionOptions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TESS&#39;</span><span class="p">)</span>
    <span class="n">validCBVTypes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiScale&#39;</span><span class="p">,</span> <span class="s1">&#39;Spike&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates a TessCotrendingBasisVectors object.</span>

<span class="sd">        Normally one would use TessCotrendingBasisVectors.from_hdu to</span>
<span class="sd">        automatically set up the object. However, for certain functionaility</span>
<span class="sd">        one must instantiate the object directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize attributes common to all CotrendingBasisVector classes</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TessCotrendingBasisVectors</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class method to instantiate a TessCotrendingBasisVectors object</span>
<span class="sd">        from a CBV FITS HDU.</span>

<span class="sd">        TESS CBVs are in separate FITS files for each camera.CCD, so camera.CCD</span>
<span class="sd">        is already specified in the HDU, here we need to specify</span>
<span class="sd">        which CBV type and band is desired.</span>

<span class="sd">        If the requested CBV type does not exist in the HDU then None is</span>
<span class="sd">        returned</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdu : astropy.io.fits.hdu.hdulist.HDUList</span>
<span class="sd">            A pyfits opened FITS file containing the CBVs</span>
<span class="sd">        cbv_type : str</span>
<span class="sd">            &#39;SingleScale&#39;, &#39;MultiScale&#39; or &#39;Spike&#39;</span>
<span class="sd">        band : int</span>
<span class="sd">            Band number for &#39;MultiScale&#39; CBVs</span>
<span class="sd">            Ignored for &#39;SingleScale&#39; or &#39;Spike&#39;</span>
<span class="sd">        **kwargs : Optional arguments</span>
<span class="sd">            Passed to the TimeSeries superclass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mission</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;TESS&#39;</span><span class="p">,</span> <span class="s1">&#39;This does not appear to be a TESS FITS HDU&#39;</span>

        <span class="c1"># Check if a valid cbv_type and band was passed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cbv_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validCBVTypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid cbv_type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid band&#39;</span><span class="p">)</span>

        <span class="c1"># Get the requested cbv_type</span>
        <span class="c1"># Curiosly, camera and CCD are not in the primary header!</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CAMERA&#39;</span><span class="p">]</span>
        <span class="n">ccd</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CCD&#39;</span><span class="p">]</span>
        <span class="n">switcher</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;SingleScale&#39;</span><span class="p">:</span> <span class="s1">&#39;CBV.single-scale.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="p">),</span>
            <span class="s1">&#39;MultiScale&#39;</span><span class="p">:</span> <span class="s1">&#39;CBV.multiscale-band-</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">,</span>
                <span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="p">),</span>
            <span class="s1">&#39;Spike&#39;</span><span class="p">:</span> <span class="s1">&#39;CBV.spike.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">ccd</span><span class="p">),</span>
            <span class="s1">&#39;unknown&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span>
            <span class="p">}</span>
        <span class="n">extName</span> <span class="o">=</span> <span class="n">switcher</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">switcher</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">extName</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalide cbv_type&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Read the columns and meta data</span>
            <span class="n">dataTbl</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">extName</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;fits&quot;</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">extName</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># TimeSeries-based objects require a dedicated time column</span>
            <span class="c1"># Replace NaNs with default time &#39;2000-01-01&#39;, otherwise,</span>
            <span class="c1"># astropy.time.Time complains</span>
            <span class="n">nanHere</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">timeData</span> <span class="o">=</span> <span class="n">dataTbl</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">timeData</span><span class="p">[</span><span class="n">nanHere</span><span class="p">]</span> <span class="o">=</span> <span class="n">Time</span><span class="p">([</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;tdb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
            <span class="n">cbvTime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">timeData</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;btjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;tdb&#39;</span><span class="p">)</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>

            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MISSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TESS&#39;</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbv_type</span>
            <span class="n">dataTbl</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">dataTbl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cbvTime</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Here we instantiate the actual object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTbl</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">cbvTime</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MISSION&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@mission</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mission</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MISSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mission</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cbv_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@cbv_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cbv_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbv_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CBV_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbv_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BAND&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@band</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;BAND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SECTOR&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@sector</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;SECTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CAMERA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@camera</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">camera</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CAMERA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">camera</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CCD&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@ccd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;CCD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccd</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span> <span class="o">==</span> <span class="s1">&#39;MultiScale&#39;</span><span class="p">):</span>
            <span class="n">repr_string</span> <span class="o">=</span> <span class="s1">&#39;TESS CBVs, Sector.Camera.CCD : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, CBVType.Band: </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, nCBVs : </span><span class="si">{}</span><span class="s1">&#39;</span> \
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repr_string</span> <span class="o">=</span> <span class="s1">&#39;TESS CBVs, Sector.Camera.CCD : </span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">, CBVType : </span><span class="si">{}</span><span class="s1">, nCBVS : </span><span class="si">{}</span><span class="s1">&#39;</span>\
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbv_type</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbv_indices</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">repr_string</span>

<span class="c1">#*******************************************************************************</span>
<span class="c1"># Functions</span>






<span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;load_kepler_cbvs&quot;</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="n">LightkurveDeprecationWarning</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_kepler_cbvs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">load_kepler_cbvs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="load_kepler_cbvs"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.load_kepler_cbvs.html#lightkurve.correctors.load_kepler_cbvs">[docs]</a><span class="k">def</span> <span class="nf">load_kepler_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mission</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quarter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">campaign</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads Kepler or K2 cotrending basis vectors, either from a local directory cbv_dir </span>
<span class="sd">    or searches the public data archive at MAST &lt;https://archive.stsci.edu&gt;.</span>

<span class="sd">    This function fetches the Cotrending Basis Vectors FITS HDU for the desired</span>
<span class="sd">    mission, quarter/campaign and channel or module/output, etc...</span>
<span class="sd">    and then extracts the requested basis vectors and returns a</span>
<span class="sd">    KeplerCotrendingBasisVectors object</span>

<span class="sd">    For Kepler/K2, the FITS files contain all channels in a single file per</span>
<span class="sd">    quarter/campaign.</span>

<span class="sd">    For Kepler this extracts the DR25 CBVs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cbv_dir : str</span>
<span class="sd">        Path to specific directory holding Kepler CBVs. If None, queries MAST.</span>
<span class="sd">    mission : str, list of str</span>
<span class="sd">        &#39;Kepler&#39; or &#39;K2&#39;</span>
<span class="sd">    quarter or campaign : int</span>
<span class="sd">        Kepler Quarter or K2 Campaign.</span>
<span class="sd">    channel or (module and output) : int</span>
<span class="sd">        Kepler/K2 requested channel or module and output.</span>
<span class="sd">        Must provide either channel, or module and output,</span>
<span class="sd">        but not both.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : :class:`KeplerCotrendingBasisVectors` object</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This example will read in the CBVs for Kepler quarter 8,</span>
<span class="sd">    and then extract the first 8 CBVs for module.output 16.4</span>

<span class="sd">        &gt;&gt;&gt; cbvs = load_kepler_cbvs(mission=&#39;Kepler&#39;, quarter=8, module=16, output=4) # doctest: +SKIP</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#***</span>
    <span class="c1"># Validate inputs</span>
    <span class="c1"># Make sure only the appropriate arguments are passed</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">):</span>
        <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">quarter</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;quarter must be passed for Kepler mission&#39;</span>
        <span class="k">assert</span>  <span class="n">campaign</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;campaign must not be passed for Kepler mission&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">):</span>
        <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">campaign</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;campaign must be passed for K2 mission&#39;</span>
        <span class="k">assert</span>  <span class="n">quarter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>  <span class="s1">&#39;quarter must not be passed for K2 mission&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown mission type&#39;</span><span class="p">)</span>

    <span class="c1"># CBV FITS files use module/output, not channel</span>
    <span class="c1"># So if channel is passed, convert to module/output</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">assert</span>  <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;module must NOT be passed if channel is passed&#39;</span>
        <span class="k">assert</span>  <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;output must NOT be passed if channel is passed&#39;</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">channel_to_module_output</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span>  <span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;module must be passed&#39;</span>
        <span class="k">assert</span>  <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;output must be passed&#39;</span>

    <span class="k">if</span> <span class="n">cbv_dir</span><span class="p">:</span>
        <span class="n">cbvBaseUrl</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">):</span>
        <span class="n">cbvBaseUrl</span> <span class="o">=</span> <span class="s2">&quot;http://archive.stsci.edu/missions/kepler/cbv/&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">):</span>
        <span class="n">cbvBaseUrl</span> <span class="o">=</span> <span class="s2">&quot;http://archive.stsci.edu/missions/k2/cbv/&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">kepler_cbv_fname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cbv_dir</span><span class="p">:</span>
            <span class="n">cbv_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cbv_dir</span><span class="p">,</span><span class="s1">&#39;*.fits&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cbvBaseUrl</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
            <span class="n">cbv_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">fn</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;Kepler&#39;</span><span class="p">:</span>
            <span class="n">quarter</span> <span class="o">=</span> <span class="s1">&#39;q</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quarter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cbv_file</span> <span class="ow">in</span> <span class="n">cbv_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">quarter</span> <span class="o">+</span> <span class="s1">&#39;-d25&#39;</span> <span class="ow">in</span> <span class="n">cbv_file</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="n">mission</span> <span class="o">==</span> <span class="s1">&#39;K2&#39;</span><span class="p">:</span>
            <span class="n">campaign</span> <span class="o">=</span> <span class="s1">&#39;c</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">campaign</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cbv_file</span> <span class="ow">in</span> <span class="n">cbv_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">campaign</span> <span class="ow">in</span> <span class="n">cbv_file</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="n">kepler_cbv_fname</span> <span class="o">=</span> <span class="n">cbvBaseUrl</span> <span class="o">+</span> <span class="n">cbv_file</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">kepler_cbv_fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">KeplerCotrendingBasisVectors</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">hdu</span><span class="o">=</span><span class="n">hdu</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CBVS were not found&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;load_tess_cbvs&quot;</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="n">LightkurveDeprecationWarning</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_tess_cbvs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">load_tess_cbvs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="load_tess_cbvs"><a class="viewcode-back" href="../../../reference/api/lightkurve.correctors.load_tess_cbvs.html#lightkurve.correctors.load_tess_cbvs">[docs]</a><span class="k">def</span> <span class="nf">load_tess_cbvs</span><span class="p">(</span><span class="n">cbv_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ccd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads TESS cotrending basis vectors, either from a directory of </span>
<span class="sd">    CBV files already saved locally if cbv_dir is passed, or else </span>
<span class="sd">    will retrieve the relevant files programmatically from MAST. </span>

<span class="sd">    This function fetches the Cotrending Basis Vectors FITS HDU for the desired</span>
<span class="sd">    cotrending basis vectors.</span>

<span class="sd">    For TESS, each CCD CBVs are stored in a separate FITS files.</span>

<span class="sd">    For now, this function will only load 2-minute cadence CBVs. Once other</span>
<span class="sd">    cadence CBVs become available this function will be updated to support</span>
<span class="sd">    their downloads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cbv_dir   : str</span>
<span class="sd">        Path to specific directory holding TESS CBVs. If None, queries MAST.</span>
<span class="sd">    sector : int, list of ints</span>
<span class="sd">        TESS Sector number.</span>
<span class="sd">    camera and ccd : int</span>
<span class="sd">        TESS camera and CCD</span>
<span class="sd">    cbv_type : str</span>
<span class="sd">        &#39;SingleScale&#39; or &#39;MultiScale&#39; or &#39;Spike&#39;</span>
<span class="sd">    band : int</span>
<span class="sd">        Multi-scale band number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : :class:`TessCotrendingBasisVectors` object</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This example will load presaved CBVs from directory &#39;.&#39; for TESS Sector 10 Camera.CCD 2.4</span>
<span class="sd">    Multi-Scale band 2</span>

<span class="sd">        &gt;&gt;&gt; cbvs = load_tess_cbvs(&#39;.&#39;,sector=10, camera=2, ccd=4, # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt;     cbv_type=&#39;MultiScale&#39;, band=2) # doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The easiest way to obtain a link to the CBV file for a TESS Sector and</span>
    <span class="c1"># camera.CCD is</span>
    <span class="c1">#</span>
    <span class="c1"># 1. Download the bulk download curl script (with a predictable url) for the</span>
    <span class="c1"># desired sector and search it for the camera.CCD needed</span>
    <span class="c1"># 2. Download the CBV FITS file based on the link in the curl script</span>
    <span class="c1">#</span>
    <span class="c1"># The bulk download curl links have urls such as:</span>
    <span class="c1">#</span>
    <span class="c1"># https://archive.stsci.edu/missions/tess/download_scripts/sector/tesscurl_sector_17_cbv.sh</span>
    <span class="c1">#</span>
    <span class="c1"># Then the individual CBV files found in the curl file have urls such as:</span>
    <span class="c1">#</span>
    <span class="c1"># https://archive.stsci.edu/missions/tess/ffi/s0017/2019/279/1-1/tess2019279210107-s0017-1-1-0161-s_cbv.fits</span>

    <span class="c1">#***</span>
    <span class="c1"># Validate inputs</span>
    <span class="c1"># Make sure only the appropriate arguments are passed</span>
    <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>    <span class="s1">&#39;sector must be passed for TESS mission&#39;</span>
    <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>    <span class="s1">&#39;camera must be passed&#39;</span>
    <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>       <span class="s1">&#39;CCD must be passed&#39;</span>
    <span class="k">if</span> <span class="n">cbv_type</span> <span class="o">==</span> <span class="s1">&#39;MultiScale&#39;</span><span class="p">:</span>
        <span class="k">assert</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>  <span class="s1">&#39;band must be passed for multi-scale CBVs&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span>  <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>  <span class="s1">&#39;band must NOT be passed for single-scale or spike CBVs&#39;</span>

    <span class="c1"># This is the string to search for in the curl script file</span>
    <span class="c1"># Pad the sector number with a first &#39;0&#39; if less than 10</span>
    <span class="c1"># TODO: figure out a way to pad an integer number with forward zeros</span>
    <span class="c1"># without needing a conditional</span>
    <span class="n">sector</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">SearchString</span> <span class="o">=</span> <span class="s1">&#39;s</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">camera</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ccd</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error parsing sector string when getting TESS CBV FITS files&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cbv_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read in the relevant curl script file and find the line for the CBV</span>
            <span class="c1"># data we are looking for</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cbv_dir</span><span class="p">,</span><span class="s1">&#39;*.fits&#39;</span><span class="p">))</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">strLine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">SearchString</span> <span class="ow">in</span> <span class="n">strLine</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">strLine</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CBV FITS file not found&#39;</span><span class="p">)</span>

            <span class="c1"># Extract url from strLine</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">curlBaseUrl</span> <span class="o">=</span> <span class="s1">&#39;https://archive.stsci.edu/missions/tess/download_scripts/sector/tesscurl_sector_&#39;</span>
            <span class="n">curlEndUrl</span> <span class="o">=</span> <span class="s1">&#39;_cbv.sh&#39;</span>
            <span class="n">curlUrl</span> <span class="o">=</span> <span class="n">curlBaseUrl</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="o">+</span> <span class="n">curlEndUrl</span>

            <span class="c1"># This is the string to search for in the curl script file</span>

            <span class="c1"># Read in the relevant curl script file and find the line for the CBV</span>
            <span class="c1"># data we are looking for</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">curlUrl</span><span class="p">)</span>
            <span class="n">foundIndex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">strLine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">SearchString</span> <span class="ow">in</span> <span class="n">strLine</span><span class="p">:</span>
                    <span class="n">foundIndex</span> <span class="o">=</span> <span class="n">strLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">SearchString</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">foundIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CBV FITS file not found&#39;</span><span class="p">)</span>

            <span class="c1"># Extract url from strLine</span>
            <span class="n">htmlStartIndex</span> <span class="o">=</span> <span class="n">strLine</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;https:&#39;</span><span class="p">)</span>
            <span class="n">htmlEndIndex</span> <span class="o">=</span> <span class="n">strLine</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
            <span class="c1"># Add 4 for length of &#39;fits&#39; string</span>
            <span class="n">tess_cbv_url</span>  <span class="o">=</span> <span class="n">strLine</span><span class="p">[</span><span class="n">htmlStartIndex</span><span class="p">:</span><span class="n">htmlEndIndex</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tess_cbv_url</span><span class="p">)</span>

        <span class="c1"># Check that this is a TESS CBV FITS file</span>
        <span class="n">mission</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;Primary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">]</span>
        <span class="n">validate_method</span><span class="p">(</span><span class="n">mission</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tess&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">TessCotrendingBasisVectors</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">hdu</span><span class="o">=</span><span class="n">hdu</span><span class="p">,</span> <span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CBVS were not found&#39;</span><span class="p">)</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright Lightkurve developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>