
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Removing noise from Kepler, K2, and TESS light curves using Cotrending Basis Vectors (CBVCorrector) &#8212; Lightkurve </title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Removing scattered light from TESS light curves using linear regression (RegressionCorrector)" href="2-3-removing-scattered-light-using-regressioncorrector.html" />
    <link rel="prev" title="How to load and use Cotrending Basis Vectors for Kepler, K2 and TESS" href="2-2-how-to-use-cbvs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-69171-9', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../index.html">
<p class="title">Lightkurve v2.5</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../whats-new-v2.html">
  What's new?
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../reference/index.html">
  API
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../about/index.html">
  About Lightkurve
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developing for Lightkurve
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/lightkurve/lightkurve" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <div class="col-12 col-md-1 col-xl-2 bd-sidebar no-sidebar"></div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Cotrending-Basis-Vector-Types">
   Cotrending Basis Vector Types
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Obtaining-the-CBVs">
   Obtaining the CBVs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Assessing-Over--and-Under-Fitting-with-the-Goodness-Metrics">
   Assessing Over- and Under-Fitting with the Goodness Metrics
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Example-Correction-with-CBVCorrector-to-Inhibit-Over-Fitting">
   Example Correction with CBVCorrector to Inhibit Over-Fitting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Using-the-Goodness-Metrics-to-Optimize-the-Fit">
   Using the Goodness Metrics to Optimize the Fit
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#No-Single-Best-Answer-Example">
   No Single Best Answer Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#...Or-Can-We-Still-Do-Better?">
   …Or Can We Still Do Better?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Using-the-Goodness-Metrics-and-CBVCorrector-with-other-Design-Matrices">
   Using the Goodness Metrics and CBVCorrector with other Design Matrices
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Some-final-comments-on-CBVCorrector">
   Some final comments on CBVCorrector
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Application-to-Kepler-vs-K2-vs-TESS">
     Application to Kepler vs K2 vs TESS
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Applicability-of-the-Over--and-Under-fitting-Goodness-Metrics">
     Applicability of the Over- and Under-fitting Goodness Metrics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Aligning-versus-Interpolating-CBVs">
     Aligning versus Interpolating CBVs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Joint-Fitting">
     Joint Fitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Hyperparameter-Optimization">
     Hyperparameter Optimization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#More-Generalized-Design-Matrix-Priors">
     More Generalized Design Matrix Priors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#NaNs,-Units-and-Normalization">
     NaNs, Units and Normalization
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-11 col-xl-8 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div style="float:right; margin-bottom:1em;">
    <a href="https://github.com/lightkurve/lightkurve/raw/main/docs/source/tutorials/2-creating-light-curves/2-3-how-to-use-cbvcorrector.ipynb"><img src="https://img.shields.io/badge/Notebook-Download-130654?logo=Jupyter&labelColor=fafafa"></a>
    <a href="https://timeseries.science.stsci.edu/hub/user-redirect/git-pull?repo=https%3A%2F%2Fgithub.com%2Flightkurve%2Flightkurve&urlpath=lab%2Ftree%2Flightkurve%2Fdocs%2Fsource%2Ftutorials/2-creating-light-curves/2-3-how-to-use-cbvcorrector.ipynb&branch=main"><img src="https://img.shields.io/badge/Notebook-Open%20in%20TIKE-130654?logo=Jupyter&labelColor=fafafa"></a>
</div>
<br style="clear:both;"><section id="Removing-noise-from-Kepler,-K2,-and-TESS-light-curves-using-Cotrending-Basis-Vectors-(CBVCorrector)">
<h1>Removing noise from Kepler, K2, and TESS light curves using Cotrending Basis Vectors (<code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code>)<a class="headerlink" href="#Removing-noise-from-Kepler,-K2,-and-TESS-light-curves-using-Cotrending-Basis-Vectors-(CBVCorrector)" title="Permalink to this headline">#</a></h1>
<p>Cotrending Basis Vectors (CBVs) are generated in the PDC component of the Kepler/K2/TESS pipeline and are used to remove systematic trends in light curves. They are built from the most common systematic trends observed in each PDC Unit of Work (Quarter for Kepler, Campaign for K2 and Sector for TESS). Each Kepler and K2 module output and each TESS CCD has its own set of CBVs. You can read an introduction to the CBVs in <a class="reference external" href="https://arxiv.org/pdf/1207.3093.pdf">Demystifying Kepler Data</a> or to
greater detail in the <a class="reference external" href="https://archive.stsci.edu/kepler/manuals/KSCI-19081-003-KDPH.pdf">Kepler Data Processing Handbook</a>. The same basic method to generate CBVs is used for all three missions.</p>
<p>This tutorial provides examples of how to utilize the various CBVs to clean lightcurves of common trends experienced by all targets. The technique exploits two goodness metrics that characterize the performance of the fit. <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.CBVCorrector.html#lightkurve.correctors.CBVCorrector">CBVCorrector</a> inherits the
<a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.RegressionCorrector.html#lightkurve.correctors.RegressionCorrector">RegressionCorrector</a> class in LightKurve. It is recommend to first read the tutorial on <a class="reference external" href="https://lightkurve.github.io/lightkurve/tutorials/2-creating-light-curves/2-2-how-to-use-cbvs.html">obtaining the CBVs</a> before reading this tutorial.</p>
<section id="Cotrending-Basis-Vector-Types">
<h2>Cotrending Basis Vector Types<a class="headerlink" href="#Cotrending-Basis-Vector-Types" title="Permalink to this headline">#</a></h2>
<p>There are three basic types of CBVs:</p>
<ul class="simple">
<li><p><strong>Single-Scale</strong> contains all systematic trends combined in a single set of basis vectors.</p></li>
<li><p><strong>Multi-Scale</strong> contains systematic trends in specific wavelet-based band passes. There are usually three sets of multi-scale basis vectors in three bands.</p></li>
<li><p><strong>Spike</strong> contains only short impulsive spike systematics.</p></li>
</ul>
<p>There are two different correction methods in PDC: Single-Scale and Multi-Scale. Single-Scale performs the correction in a single bandpass. Multi-Scale performs the correction in three separate wavelet-based bandpasses. Both corrections are performed in PDC but we can only export a single PDC light curve for each target. So, PDC must choose which of the two to export on a per-target basis. Generally speaking, single-scale performs better at preserving longer period signals. But at periods close
to transiting planet durations multi-scale performs better at preserving signals. PDC therefore mostly chooses multi-scale for use within the planet finding pipeline and for the archive. You can find in the light curve FITS header which PDC method was chosen (keyword “PDCMETHD”). Additionally, a seperate correction is alway performed to remove short impulsive systematic spikes.</p>
<p>For an individual’s research needs, the mission supplied PDC lightcurves might not be ideal and so the CBVs are provided to the user to perform their own correction. All three CBV types are provided at MAST for TESS, however only Single-Scale is provided at MAST for Kepler and K2. Also for Kepler and K2, Cotrending Basis Vectors are supplied for only the 30-minute target cadence.</p>
</section>
<section id="Obtaining-the-CBVs">
<h2>Obtaining the CBVs<a class="headerlink" href="#Obtaining-the-CBVs" title="Permalink to this headline">#</a></h2>
<p>One can directly obtain the CBVs with <code class="docutils literal notranslate"><span class="pre">load_tess_cbvs</span></code> and <code class="docutils literal notranslate"><span class="pre">load_kepler_cbvs</span></code>, either from MAST by default or from a local directory <code class="docutils literal notranslate"><span class="pre">cbv_dir</span></code>. However when generating a <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.CBVCorrector.html#lightkurve.correctors.CBVCorrector">CBVCorrector</a> object the appropriate CBVs are automatically downloaded from MAST and aligned to the lightcurve. Let’s generate this object for a particularily interesting TESS variable
target. We first download the SAP lightcurve.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span><span class="w"> </span><span class="nn">lightkurve</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_lightcurve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">lc</span> <span class="o">=</span> <span class="n">search_lightcurve</span><span class="p">(</span><span class="s1">&#39;TIC 99180739&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;SPOC&#39;</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">flux_column</span><span class="o">=</span><span class="s1">&#39;sap_flux&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, we create a <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> object. This will download the CBVs appropriate for this target and store them in the <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> object. In the case of TESS, this means the CBVs associated with the CCD this target is on and for Sector 10.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lightkurve.correctors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CBVCorrector</span>
<span class="n">cbvCorrector</span> <span class="o">=</span> <span class="n">CBVCorrector</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s look at the CBVs downloaded.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">cbvs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[TESS CBVs, Sector.Camera.CCD : 10.1.1, CBVType : SingleScale, nCBVS : 16,
 TESS CBVs, Sector.Camera.CCD : 10.1.1, CBVType.Band: MultiScale.1, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 10.1.1, CBVType.Band: MultiScale.2, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 10.1.1, CBVType.Band: MultiScale.3, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 10.1.1, CBVType : Spike, nCBVS : 6]
</pre></div></div>
</div>
<p>We see that there are a total of 5 sets of CBVs, all associated with TESS Sector 10, Camera 1 and CCD 1. The number of CBVs per type is also given. Let’s plot the Single-Scale CBVs, which contain all systematics combined.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">cbvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_12_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_12_0.png" />
</div>
</div>
<p>The first several CBVs contain most of the systematics. The latter CBVs pose a greater risk of injecting more noise than helping. The default behavior in CBVCorrector is to use the first 8 CBVs.</p>
</section>
<section id="Assessing-Over--and-Under-Fitting-with-the-Goodness-Metrics">
<h2>Assessing Over- and Under-Fitting with the Goodness Metrics<a class="headerlink" href="#Assessing-Over--and-Under-Fitting-with-the-Goodness-Metrics" title="Permalink to this headline">#</a></h2>
<p>Two very common issues when fitting a model to a data set it over-fitting and under-fitting.</p>
<p>Over-fitting occurs when the model has too many degrees of freedom and fits the data <em>at all costs</em>, instead of just modelling the physical process it is attempting to model. This can exhibit itself in different ways, depending on the system and application. In the case of fitting systematic trend basis vectors to a time series, over-fitting can result in the basis vectors removing intrinsic signals in the times series instead of just the systematics. It can also result in introduced broad-band
noise. This can be particularily prominant in an unconstrained least-squares fit. A least-squares fit only cares about minimizing it’s loss function, which is the Root Mean Square error. In the course of minimizing the RMS, narrow-band power representing the systematic trends are exchanged for broad-band noise intrinsic in the basis vectors. This results in the overall RMS decreasing but the noise in the time series increasing, resulting in the obscuration of the signals under interest. A very
common method to inhibit over-fitting is to introduce a regularization term in the loss function. This constrains the fit and effectively reduces the degrees of freedom.</p>
<p>Under-fitting occurs when the model has too few degrees of freedom and fails to adequately model the physical process it is attempting to model. In the case of fitting systematic trend basis vectors to a time series, under-fitting can result in residual systematics. Under-fitting can either be the result of the basis vectors not adequately representing the systematics or, placing too great of a restriction on the model during fitting. The regularization technique used to inhibit over-fitting can
therefore result in under-fitting. The ideal fit will balance the counter-acting phenomena of over- and under-fitting. To this end, a method can be developed to measure the degree to which these two phenomena occur.</p>
<p>PDC has two <strong>Goodness Metrics</strong> to assess over- and under-fitting:</p>
<ul class="simple">
<li><p><strong>Over-fitting metric</strong>: Measures the introduced noise in the light curve after the correction. It does so by measuring the broad-band power spectrum via a Lomb-Scargle Periodogram both before and after the correction. If power has increased after the correction then this is an indication the CBV fit has over-fitted and introduced noise. The metric treats all frequencies equally when measuring power increase; from one frequency separation to the Nyquist frequency. This metric is callibrated
such that a metric value of 0.5 means the introduced noise due to over-fitting is at the same power level as the uncertainties in the light curve.</p></li>
<li><p><strong>Under-fitting metric</strong>: Measures the mean residual target to target Pearson correlation between the target under study and a selection of neighboring targets. This metric will find and download a selection of neighboring SPOC SAP targets in RA and Decl. until a minimum number is found. The metric is callibrated such that a value of 0.95 means the residual correlations in the target is equivalent to chance correlations of White Gaussian Noise.</p></li>
</ul>
<p><em>The Goodness Metrics are not perfect!</em> They are an estimate of over- and under-fitting and are to be used as a guideline along other other metrics to assess the quality of your light curve.</p>
<p>The Goodness Metrics are part of the <code class="docutils literal notranslate"><span class="pre">lightkurve.correctors.metrics</span></code> module and can be computed directly with calls to <code class="docutils literal notranslate"><span class="pre">overfit_metric_lombscargle</span></code> and <code class="docutils literal notranslate"><span class="pre">underfit_metric_neighbors</span></code>. The ‘CBVCorrector’ has convenience wrappers for the two metrics and so they do not need to be called directly, as we will show below.</p>
</section>
<section id="Example-Correction-with-CBVCorrector-to-Inhibit-Over-Fitting">
<h2>Example Correction with CBVCorrector to Inhibit Over-Fitting<a class="headerlink" href="#Example-Correction-with-CBVCorrector-to-Inhibit-Over-Fitting" title="Permalink to this headline">#</a></h2>
<p>There are four correction methods within <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code>:</p>
<ul class="simple">
<li><p><strong>correct</strong>: Performs a numerical correction using the LightKurve <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.RegressionCorrector.correct.html#lightkurve.correctors.RegressionCorrector.correct">RegressionCorrector.correct</a> method while optimizing the L2-Norm regularization penalty term using the goodness metrics as the Loss Function.</p></li>
<li><p><strong>correct_gaussian_prior</strong>: Performs an analytical correction using the LightKurve <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.RegressionCorrector.correct.html#lightkurve.correctors.RegressionCorrector.correct">RegressionCorrector.correct</a> method while setting the L2-Norm (Ridge Regression) regularization penalty term as the Gaussian prior.</p></li>
<li><p><strong>correct_elasticnet</strong>: Performs the correction using Scikit-Learn’s <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.ElasticNet.html">ElasticNet</a>, which combines both an L1- and L2-Norm regularization.</p></li>
<li><p><strong>correct_regressioncorrector</strong>: Performs the standard <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.RegressionCorrector.correct.html#lightkurve.correctors.RegressionCorrector.correct">RegressionCorrector.correct</a> correction. RegressionCorrector is the superclass to CBVCorrector and this is a “passthrough” method to access the superclass <code class="docutils literal notranslate"><span class="pre">correct</span></code> method.</p></li>
</ul>
<p>If you are unfamilar with L1-Norm (LASSO) and L2-Norm (Ridge Regression) regularization then there are <a class="reference external" href="https://www.statlearning.com/">severel</a>, <a class="reference external" href="https://press.princeton.edu/books/hardcover/9780691198309/statistics-data-mining-and-machine-learning-in-astronomy">excellent</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Regularization_(mathematics)">introductions</a>. You can read how a L2-norm relates to a Gaussian prior in a linear design matrix in <a class="reference external" href="https://katbailey.github.io/post/from-both-sides-now-the-math-of-linear-regression/">this
reference</a>.</p>
<p>The default method is <code class="docutils literal notranslate"><span class="pre">correct</span></code> and generally speaking, one can use just this method to obtain a good fit. The other methods are for advanced usage.</p>
<p>We’ll start with <code class="docutils literal notranslate"><span class="pre">correct_gaussian_prior</span></code> in order to introduce the concepts. Doing so will allow us to force a very weak regularization term (alpha=1e-4) as an illustration.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select which CBVs to use in the correction</span>
<span class="n">cbv_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="s1">&#39;Spike&#39;</span><span class="p">]</span>
<span class="c1"># Select which CBV indices to use</span>
<span class="c1"># Use the first 8 SingleScale and all Spike CBVS</span>
<span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;ALL&#39;</span><span class="p">]</span>
<span class="c1"># Perform the correction</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_19_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_19_0.png" />
</div>
</div>
<p>First note that CBVCorrector always fits a constant term in the model, but the constant is never subtracted in the resultant corrected flux. The median flux value of the light curve is always preserved.</p>
<p>At first sight, this looks like a good correction. Both the Single-Scale and Spike basis vectors are being utilized to fit out as much of the signal as possible. The corrected light curve is indeed flatter. But this was essentially an unrestricted least-squares correction and we may have <em>over-fitted</em>. The very strong lips right at the beginning of each orbit is probably a chance correlation between the star’s inherent stellar variability and the thermal settling systematic that is common in
Kepler and TESS lightcurves. Let’s look at the CBVCorrector goodness metrics to determine if this is the case.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note: this cell will be slow to run</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Over fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Under fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Over fitting Metric: 0.7126447145580249
Under fitting Metric: 0.9697057245444944
</pre></div></div>
</div>
<p>The first time you run the under-fitting goodness metric it will download the SPOC SAP light curves of targets in the neighborhood around the target under study in order to estimate the residual systematics (they are stored in the CBVCorrector object for subsequent computations). A goodness metric of 0.8 or above is generally considered good. In this case, it looks like we over-fitted (over-fitting metric = 0.71). Even though the corrected light curve looks better, our metric is telling us we
probably injected signals into our lightcurve and we should not trust this really nice looking curve. Perhaps we can do better if we <em>regularize</em> the fit.</p>
</section>
<section id="Using-the-Goodness-Metrics-to-Optimize-the-Fit">
<h2>Using the Goodness Metrics to Optimize the Fit<a class="headerlink" href="#Using-the-Goodness-Metrics-to-Optimize-the-Fit" title="Permalink to this headline">#</a></h2>
<p>We will start by performing a scan of the over- and under-fit goodness metrics as a function of the L2-Norm regularization term, alpha.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_25_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_25_0.png" />
</div>
</div>
<p>This scan also plots the last used alpha parameter as a vertical black line (alpha=1e-4 in our case). We are clearly not optimizing this fit for both over- and under-fitting. Let’s use the <code class="docutils literal notranslate"><span class="pre">correct</span></code> numerical optimizer to try to optimize the fit.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimized Over-fitting metric: 0.9996590294149641
Optimized Under-fitting metric: 0.8235713988608696
Optimized Alpha: 9.861e+03
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_27_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_27_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_27_2.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_27_2.png" />
</div>
</div>
<p>Much better! We see the thermal settling systematic is still being removed, but the stellar variabity is better preserved. Note that the optimizer did not set the alpha parameter at exactly the red and blue curve intersection point. The default target goodness scores is 0.8 or above, which is fulfilled at alpha=1.45e-1. If we want to optimize the fit even more, by perhaps ensuring we are not over-fitting at all, then we can adjust the target over and under scores to emphasize which metric we are
more interested in. Below we more greatly emphasize improving the over-fitting metric by setting the target to 0.9.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span>
                     <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span>
                     <span class="n">target_over_score</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                     <span class="n">target_under_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimized Over-fitting metric: 0.9996576332257768
Optimized Under-fitting metric: 0.823571240085119
Optimized Alpha: 9.701e+03
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_29_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_29_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_29_2.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_29_2.png" />
</div>
</div>
<p>We are now perhaps biasing too far towards under-fitting, but depending on your research interests, this might be best.</p>
</section>
<section id="No-Single-Best-Answer-Example">
<h2>No Single Best Answer Example<a class="headerlink" href="#No-Single-Best-Answer-Example" title="Permalink to this headline">#</a></h2>
<p>Let’s now look at another example, this time where there is no clear single best answer. Again, we will use the Single-Scale and Spike basis vectors for the correction and begin with low regularization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lc</span> <span class="o">=</span> <span class="n">search_lightcurve</span><span class="p">(</span><span class="s1">&#39;TIC 38574307&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s1">&#39;SPOC&#39;</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">flux_column</span><span class="o">=</span><span class="s1">&#39;sap_flux&#39;</span><span class="p">)</span>
<span class="n">cbvCorrector</span> <span class="o">=</span> <span class="n">CBVCorrector</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
<span class="n">cbv_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SingleScale&#39;</span><span class="p">,</span> <span class="s1">&#39;Spike&#39;</span><span class="p">]</span>
<span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;ALL&#39;</span><span class="p">]</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_33_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_33_0.png" />
</div>
</div>
<p>At first sight, this looks good. The long term trends have been removed and the periodic noisy bits have been removed with the spike basis vectors. But did we really do a good job?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Over fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Under fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">()))</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Over fitting Metric: 0.2627631352877169
Under fitting Metric: 0.9995801211972846
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_35_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_35_1.png" />
</div>
</div>
<p>Hmm… The over-fitting goodness metric says we are severely over-fitting. Not only that, there appears to not be an Alpha parameter that brings both goodness metrics above 0.8. And yet, the fit looks really good. What’s going on here? Let’s zoom in on the correction.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pltAxis</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1360.5</span><span class="p">,</span> <span class="mf">1361.1</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.4755e7</span><span class="p">,</span> <span class="mf">1.477e7</span><span class="p">);</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1360.5</span><span class="p">,</span> <span class="mf">1361.1</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.475e7</span><span class="p">,</span> <span class="mf">1.477e7</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_37_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_37_0.png" />
</div>
</div>
<p>We see in the top plot that the <em>SingleScale</em> correction has comperable noise to the <em>original</em> light curve. This means the correction is injecting high frequency noise at comperable amplitude to the original signal. We have indeed over-fitted! The goodness metrics perform a <em>broad-band</em> analysis of over- and under-fitting. Even though our eyes did not see the high frequency noise injection, the goodness metrics did. So, what should be done? It depends on what you are trying to investigate. If
you are only looking at the low frequency signals in the data then perhaps you don’t care about the high frequency noise injection. If you really do care about the high frequency signals then you should increase the Alpha parameter, or set the target goodness scores as we do below (target_over_score=0.8, target_under_score=0.5).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optimize the fit but overemphasize the importance of not over-fitting.</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span>
                     <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span>
                     <span class="n">target_over_score</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                     <span class="n">target_under_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimized Over-fitting metric: 0.7972715336819081
Optimized Under-fitting metric: 0.4674498741965995
Optimized Alpha: 3.263e+00
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_39_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_39_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_39_2.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_39_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Again, zoom in to see the detail</span>
<span class="n">pltAxis</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1360.5</span><span class="p">,</span> <span class="mf">1361.1</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.4755e7</span><span class="p">,</span> <span class="mf">1.477e7</span><span class="p">);</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1360.5</span><span class="p">,</span> <span class="mf">1361.1</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.475e7</span><span class="p">,</span> <span class="mf">1.477e7</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_40_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_40_0.png" />
</div>
</div>
<p>We see now that the high frequency noise injection is small compared to the original amplitudes in the lightkurve. We barely removed any of the systematics and are now under-fitting, but that might be the best we can do if we want to ensure low noise injection.</p>
</section>
<section id="...Or-Can-We-Still-Do-Better?">
<h2>…Or Can We Still Do Better?<a class="headerlink" href="#...Or-Can-We-Still-Do-Better?" title="Permalink to this headline">#</a></h2>
<p>Perhaps we are using the incorrect CBVs for this target. Below is a tuned multi-step fit where we first fit the multi-scale Band 2 CBVs then the Spike CBVs. The multi-scale band 2 CBVs contain intermediate frequency systematic signals. They should not inject high frequency noise. We also utilize the <code class="docutils literal notranslate"><span class="pre">correct_elasticnet</span></code> corrector, which allows us to add in a L1-Norm term (Lasso Regularization). L1-Norm helps snap some basis vector fit coefficients to zero and can result in a more stable, less
noisy fit. The result is a much better compromise between over- and under-fitting. The spikes are not well removed but increasing the weight on the Spike CBV removal results in over-fitting. We can also try the multi-scale band 3 CBVs, which contain high frequency systematics, but the over-fitting metric indicates using them results in even greater over-fitting. The resultant is now much better than what we achieved above but more tuning and optimization could possibly get us even closer to an
ideal fit.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit to the Multi-Scale Band 2 CBVs with ElasticNet to add in a L1-Norm (Lasso) term</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct_elasticnet</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MultiScale.2&#39;</span><span class="p">],</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0e-7</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Result of First Correction to MultiScale.2 CBVs&#39;</span><span class="p">);</span>

<span class="c1"># Set the corrected LC as the initial LC in a new CBVCorrector object before moving to the next correction.</span>
<span class="c1"># You could instead just reassign to the first cbvCorrector object, if you do not wish to save the original.</span>
<span class="n">cbvCorrectorIter2</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Fit to the Spike Basis Vectors, using an L1-Norm term.</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">correct_elasticnet</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Spike&#39;</span><span class="p">],</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">2.0e-5</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Result of Second Correction to Spike CBVs&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_44_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_44_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_44_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_44_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the final goodness metrics compared to the original lightcurve.</span>
<span class="c1"># This requires us to copy the original light curve into cbvCorrectorIter2.lc so that the goodness metrics compares the corrected_lc to the proper initial light curve.</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Over-fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Under-fitting Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">under_fitting_metric</span><span class="p">()))</span>

<span class="c1"># Plot the final correction</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">corrected_lc</span><span class="p">[</span><span class="o">~</span><span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">cadence_mask</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                                            <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                            <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Outliers&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbvCorrectorIter2</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Corrected&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparison between original and final corrected lightcurve&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Over-fitting Metric: 0.6135295975768081
Under-fitting Metric: 0.8830315929531105
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_45_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_45_1.png" />
</div>
</div>
<p>So, which CBVs are best to use? There is no one single answer, but generally speaking, the Multi-Scale Basis vectors are more versatile. The trade-off is there are also more of them, which means more degrees of freedom in your fit. More degrees of freedom can result in more over-fitting without proper regularization. It is recommened the user tries different combinations of CBVs and use objective metrics to decide which fit is the best for their particular needs.</p>
</section>
<section id="Using-the-Goodness-Metrics-and-CBVCorrector-with-other-Design-Matrices">
<h2>Using the Goodness Metrics and CBVCorrector with other Design Matrices<a class="headerlink" href="#Using-the-Goodness-Metrics-and-CBVCorrector-with-other-Design-Matrices" title="Permalink to this headline">#</a></h2>
<p>The Goodness Metrics and CBVCorrector can also be used in conjunction with other external design matrices. Let’s work on a famous planet example to show how the CBVCorrector can be utilized to imporove the generated light curve. We will begin by using <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.search_tesscut.html#lightkurve.search_tesscut">search_tesscut</a> to extract an FFI light curve for HAT-P 11 and then create a DesignMatrix using the background pixels.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HAT-P 11b</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightkurve</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_tesscut</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightkurve.correctors</span><span class="w"> </span><span class="kn">import</span> <span class="n">DesignMatrix</span>
<span class="n">search_result</span> <span class="o">=</span> <span class="n">search_tesscut</span><span class="p">(</span><span class="s1">&#39;HAT-P-11&#39;</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">search_result</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">cutout_size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1"># Create a simple thresholded aperture mask</span>
<span class="n">aper</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">create_threshold_mask</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">reference_pixel</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="c1"># Generate a simple aperture photometry light curve</span>
<span class="n">raw_lc</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">to_lightcurve</span><span class="p">(</span><span class="n">aperture_mask</span><span class="o">=</span><span class="n">aper</span><span class="p">)</span>
<span class="c1"># Create a design matrix using PCA components from the cutout background</span>
<span class="n">dm</span> <span class="o">=</span> <span class="n">DesignMatrix</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">flux</span><span class="p">[:,</span> <span class="o">~</span><span class="n">aper</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pixel regressors&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">append_constant</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.DesignMatrix.html#lightkurve.correctors.DesignMatrix">DesignMatrix</a> <code class="docutils literal notranslate"><span class="pre">dm</span></code> now contains the common trends in the background pixels in the data. We will first try to fit the pixel-based design matrix using an unrestricted least-squares fit (I.e. a very weak regularization by setting alpha to a small number). We tell CBVCorrector to only use the external design matrix with <code class="docutils literal notranslate"><span class="pre">ext_dm=</span></code>. When we generate the
CBVCorrector object the CBVs will be downloaded, but the CBVs are for 2-minute cadence and not the 30-minute FFIs. We therefore use the <code class="docutils literal notranslate"><span class="pre">interpolate_cbvs=True</span></code> option to tell the CBVCorrector to interpolate the CBVs to the light curve cadence.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate the CBVCorrector object and interpolate the downloaded CBVs to the light curve cadence</span>
<span class="n">cbvcorrector</span> <span class="o">=</span> <span class="n">CBVCorrector</span><span class="p">(</span><span class="n">raw_lc</span><span class="p">,</span> <span class="n">interpolate_cbvs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Perform an unrestricted least-squares fit using only the pixel-derived design matrix.</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">dm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Over-fitting metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CDPP: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">estimate_cdpp</span><span class="p">()))</span>
<span class="n">corrected_lc_just_pixel_dm</span> <span class="o">=</span> <span class="n">cbvcorrector</span><span class="o">.</span><span class="n">corrected_lc</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Over-fitting metric: 0.07934178768293251
CDPP: 230.75800316870175 ppm
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_51_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_51_1.png" />
</div>
</div>
<p>The least-squares fit did remove the background flux trend and at first sight the resultant might look good, but the over-fitting goodness metric is <code class="docutils literal notranslate"><span class="pre">0.08</span></code>. That’s not very good! It looks like we are dramatically over-fitting. We can see this in the bottom plot where the corrected curve has more high-frequency noise than the original. Let’s now add in the multi-scale basis vectors and see if we can do better. Note that we are joint fitting the CBVs and the external pixel-derived design matrix.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbv_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MultiScale.1&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiScale.2&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiScale.3&#39;</span><span class="p">,</span><span class="s1">&#39;Spike&#39;</span><span class="p">]</span>
<span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;ALL&#39;</span><span class="p">]</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">dm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Over-fitting metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">over_fitting_metric</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CDPP: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">estimate_cdpp</span><span class="p">()))</span>
<span class="n">corrected_lc_joint_fit</span> <span class="o">=</span> <span class="n">cbvcorrector</span><span class="o">.</span><span class="n">corrected_lc</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Over-fitting metric: 0.3158556246937666
CDPP: 55.83742644427681 ppm
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_53_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_53_1.png" />
</div>
</div>
<p>That looks a lot better! Could we do a bit better by adding in a regularization term? Let’s do a goodness metric scan.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">dm</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_55_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_55_0.png" />
</div>
</div>
<p>There are a couple observations to make here.</p>
<p>First, the under-fitting metric has a very good score throughout the regularization scan. This is because the under-fitting metric compares the corrected light curve to neighboring targets in RA and Decl. that are archived as 2-minute SAP-flux targets. <em>The SAP flux already has the background removed</em> so the neighoring targets do not contain the very large background trends. The under-fitting metric is therefore not very helpful. In the next run we will disable the under-fitting metric in the
optimization (by setting target_under_score=-1).</p>
<p>We see the over-fitting metric is not a simple function of the regularization factor <em>alpha</em>. This can happen due to the interaction of the various basis vectors during fitting when regularization is applied. We see a minima (most over-fitting) at about alpha=1e-1. Once alpha moves above this value we begin to over-constrain the fit which results in gradually less removal of systematics. The under-fitting metric should be an indicator that we are going too far constraining the fit, and indeed,
we do see the under-fitting metric degrades slightly beginning at alpha=1e-1.</p>
<p>We will now try to optimize the fit and account for these two issues by 1) setting the bounds on the alpha parameter (<code class="docutils literal notranslate"><span class="pre">alpha_bounds=[1e-6,</span> <span class="pre">1e-2]</span></code>) and 2) disregarding the under-fitting metric (<code class="docutils literal notranslate"><span class="pre">target_under_score=-1</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optimize the fit but ignore the under-fitting metric and set bounds on the alpha parameter.</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">ext_dm</span><span class="o">=</span><span class="n">dm</span><span class="p">,</span> <span class="n">alpha_bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">],</span> <span class="n">target_over_score</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">target_under_score</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CDPP: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvcorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">estimate_cdpp</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimized Over-fitting metric: 0.35271734036672664
Optimized Alpha: 8.296e-04
CDPP: 67.73407243529186 ppm
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_57_1.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_57_1.png" />
</div>
</div>
<p>This is looking like a pretty good light curve. However, the <a class="reference external" href="https://arxiv.org/pdf/1208.0595">CDPP</a> increased a little as we optimized the over-fitting metric. Which correction to use may depend on your application. Since we are interested in the transiting planet, we will choose the corrected light curve with the lowest CDPP. Below we compare the light curve between just using the pixel-derived design matrix to also adding in the CBVs as a joint, regularized fit.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">cbvcorrector</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Uncorrected LC&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">corrected_lc_just_pixel_dm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel-Level Corrected; CDPP=</span><span class="si">{0:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corrected_lc_just_pixel_dm</span><span class="o">.</span><span class="n">estimate_cdpp</span><span class="p">()),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="n">corrected_lc_joint_fit</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Joint Fit Corrected; CDPP=</span><span class="si">{0:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corrected_lc_joint_fit</span><span class="o">.</span><span class="n">estimate_cdpp</span><span class="p">()),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparison Between original and final corrected lightcurve&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_59_0.png" src="../../_images/tutorials_2-creating-light-curves_2-3-how-to-use-cbvcorrector_59_0.png" />
</div>
</div>
<p>The superiority of the bottom curve is blatantly obvious. We can clearly see HAT-P 11b on it’s 4.9 day period orbit. Our over-fitting metric settled at about 0.35 indicating we might still be over-fitting and should keep that in mind. However the low CDPP indicates the over-fitting is probably not over transit time-scales.</p>
</section>
<section id="Some-final-comments-on-CBVCorrector">
<h2>Some final comments on CBVCorrector<a class="headerlink" href="#Some-final-comments-on-CBVCorrector" title="Permalink to this headline">#</a></h2>
<section id="Application-to-Kepler-vs-K2-vs-TESS">
<h3>Application to Kepler vs K2 vs TESS<a class="headerlink" href="#Application-to-Kepler-vs-K2-vs-TESS" title="Permalink to this headline">#</a></h3>
<p>CBVCorrector works equally across Kepler, K2 and TESS. However the Multi-Scale and Spike basis vectors are only available for TESS1. For K2, the <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.PLDCorrector.html#lightkurve.correctors.PLDCorrector">PLDCorrector</a> and <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.SFFCorrector.html#lightkurve.correctors.SFFCorrector">SFFCorrector</a> classes might work better than
<code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code>.</p>
<p>If you want to just get the CBVs but not generate a CBVCorrector object then use the functions <em>load_kepler_cbvs</em> and <em>load_tess_cbvs</em> within the cbvcorrector module as explained <a class="reference external" href="https://lightkurve.github.io/lightkurve/tutorials/2-creating-light-curves/2-2-how-to-use-cbvs.html">here</a>.</p>
<p>1 Unfortunately, the Multi-Scale and Spike CBVs are not archived at MAST for Kepler/K2.</p>
</section>
<section id="Applicability-of-the-Over--and-Under-fitting-Goodness-Metrics">
<h3>Applicability of the Over- and Under-fitting Goodness Metrics<a class="headerlink" href="#Applicability-of-the-Over--and-Under-fitting-Goodness-Metrics" title="Permalink to this headline">#</a></h3>
<p>The under-fitting metric computes the correlation between the corrected light curve and a selection of neighboring SPOC SAP light curves. If the light curve you are trying to correct was not generated by the SPOC pipeline (I.e. not a SAP light curve), then the neighboring SAP light curves might not contain the same instrumental systematics and the under-fitting metric might not properly measure when under-fitting is occuring.</p>
<p>The over-fitting metric examines the periodogram of the light curve before and after the correction and is therefore indifferent to how the light curve was generated. It simply looks to see if noise was injected into the light curve. The over-fitting metric is therefore much more generally applicable.</p>
<p>The Goodness Metrics are part of the <code class="docutils literal notranslate"><span class="pre">lightkurve.correctors.metrics</span></code> module and can be computed directly with calls to <code class="docutils literal notranslate"><span class="pre">overfit_metric_lombscargle</span></code> and <code class="docutils literal notranslate"><span class="pre">underfit_metric_neighbors</span></code>. A savvy expert user can use these and other quality metrics to generate their own Loss Function for optimizing a fit.</p>
</section>
<section id="Aligning-versus-Interpolating-CBVs">
<h3>Aligning versus Interpolating CBVs<a class="headerlink" href="#Aligning-versus-Interpolating-CBVs" title="Permalink to this headline">#</a></h3>
<p>By default, all loaded CBVS in <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> are “aligned” to the light curve cadence numbers (<code class="docutils literal notranslate"><span class="pre">CBVCorrector.lc.cadenceno</span></code>). This means only cadence numbers that exist in both the CBVs and the light curve will have values in the returned CBVs. All cadence numbers that exist in the light curve but not in the CBVs will have NaNs returned for the CBVs on those cadences and the Gap Indicator set to True. Any cadences in the CBVs not in the light curve will be removed from the CBVs.</p>
<p>If the light curve cadences do not overlap well with the CBVs then you can set <code class="docutils literal notranslate"><span class="pre">interpolate_cbvs=True</span></code> when generating the <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> object. Doing so will generate interpolated CBV values for all cadences in the light curve. If the light curve has cadences past either end of the cadences in the CBVs then one must extrapolate. A second argument, <code class="docutils literal notranslate"><span class="pre">extrapolate_cbvs</span></code>, can be used to also extrapolate the CBV values to the light curve cadences. If <code class="docutils literal notranslate"><span class="pre">extrapolate_cbvs=False</span></code> then the
exterior values are set to NaNs, which will probably result is a very poor fit.</p>
<p><strong>Warning</strong>: <em>The safest method is to align</em>. This will not generate any new values for the CBVs. Interpolation can be potentially dangerous. Interpolation uses Piecewise Cubic Hermite Interpolating Polynomial (PCHIP), which can be more stable than a simple spline, but no interpolation method works in all situations. Extrapolation is even more dangerious, which is why an extra parameter must be set if one desires to extrapolate. <em>Be sure to manually examine the extrapolated CBVs before use!</em></p>
</section>
<section id="Joint-Fitting">
<h3>Joint Fitting<a class="headerlink" href="#Joint-Fitting" title="Permalink to this headline">#</a></h3>
<p>By including the <code class="docutils literal notranslate"><span class="pre">ext_dm=</span></code> parameter in the <code class="docutils literal notranslate"><span class="pre">correct_*</span></code> methods we allow for joint fitting between the CBVs and other design matrices. Generally speaking, if fitting a collection of different models to a system, joint fitting is ideal. For example, if performing transit analysis one could add in a transit model to the joint fit to get the best transit recovery. The fit coefficient to the transit model is stored in the <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> object after fitting and can be recovered.</p>
</section>
<section id="Hyperparameter-Optimization">
<h3>Hyperparameter Optimization<a class="headerlink" href="#Hyperparameter-Optimization" title="Permalink to this headline">#</a></h3>
<p>Any model fitting should include a hyperparameter optimization step. The <code class="docutils literal notranslate"><span class="pre">correct_optimizer</span></code> is essentially a 1-dimensional optimizer and is very fast. More advanced hypterparameter optimization can be performed by tuning the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">l1_ratio</span></code> parameters in <code class="docutils literal notranslate"><span class="pre">correct_elasticnet</span></code> plus the number and type of CBVs, along with an external design matrix. The optimization Loss Function can use a combination of the <code class="docutils literal notranslate"><span class="pre">under_fitting_metric</span></code>, <code class="docutils literal notranslate"><span class="pre">over_fitting_metric</span></code> and <code class="docutils literal notranslate"><span class="pre">lc.estimate_cdpp</span></code>
methods. Writing such an optimzer is left as an exercise to the reader and to be tuned to the reader’s particular application.</p>
</section>
<section id="More-Generalized-Design-Matrix-Priors">
<h3>More Generalized Design Matrix Priors<a class="headerlink" href="#More-Generalized-Design-Matrix-Priors" title="Permalink to this headline">#</a></h3>
<p>The main <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.CBVCorrector.correct.html#lightkurve.correctors.CBVCorrector.correct">CBVCorrector.correct*</a> methods utilize a similar prior for all design matrix vectors as is typically used in L1-Norm and L2-Norm regularization. However you can perform fine tuning to the correction using more sophisticated priors. After performing a fit with one of the <code class="docutils literal notranslate"><span class="pre">CBVCorrector.correct*</span></code> methods,
<code class="docutils literal notranslate"><span class="pre">CBVCorrector.design_matrix_collection</span></code> will have the priors set. One can then manually adjust the priors and use <code class="docutils literal notranslate"><span class="pre">CBVCorrector.correct_regressioncorrector</span></code> to perform the standard <a class="reference external" href="https://lightkurve.github.io/lightkurve/reference/api/lightkurve.correctors.RegressionCorrector.correct.html#lightkurve.correctors.RegressionCorrector.correct">RegressionCorrector.correct</a> correction. An illustration is below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1) Perform an initial optimization with a L2-Norm regularization</span>
<span class="c1"># cbvCorrector.correct(cbv_type=cbv_type, cbv_indices=cbv_indices);</span>

<span class="c1"># 2) Examine the quality of the resultant lightcurve in cbvcorrector.corrected_lc</span>
<span class="c1"># Determine how to adjust the priors and make changes to the design matrix</span>
<span class="c1"># cbvCorrector.design_matrix_collection[i].prior_sigma[j] = # ... adjust the priors</span>

<span class="c1"># 3) Call the superclass correct method with the adjusted design_matrix_collection</span>
<span class="c1"># cbvCorrector.correct_regressioncorrector(cbvCorrector.design_matrix_collection, **kwargs)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cbvCorrector.corrected_lc</span></code> will now be the result of the fit using whatever <code class="docutils literal notranslate"><span class="pre">cbvCorrector.design_matrix_collection</span></code> you had just provided.</p>
</section>
<section id="NaNs,-Units-and-Normalization">
<h3>NaNs, Units and Normalization<a class="headerlink" href="#NaNs,-Units-and-Normalization" title="Permalink to this headline">#</a></h3>
<p>NaNs are removed from the light curve when used to generate the <code class="docutils literal notranslate"><span class="pre">CBVCorrector</span></code> object and is stored in <code class="docutils literal notranslate"><span class="pre">CBVCorrector.lc</span></code>.</p>
<p>The CBVCorrector performs its corrections in absolute flux units (typically electrons per second). The returned corrected light curve <code class="docutils literal notranslate"><span class="pre">corrected_lc</span></code> is also in absolute units and the median flux of the light curve is preserved.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LC unit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Corrected LC unit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
LC unit: electron / s
Corrected LC unit: electron / s
</pre></div></div>
</div>
<p>The goodness metrics are computed using median normalized units in order to properly calibrate the metric to be between 0.0 and 1.0 for all light curves. The normalization is as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">normalized_lc</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
<span class="n">normalized_lc</span> <span class="o">-=</span> <span class="mf">1.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Normalized Light curve units: </span><span class="si">{}</span><span class="s1"> (i.e astropy.units.dimensionless_unscaled)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normalized_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Normalized Light curve units:  (i.e astropy.units.dimensionless_unscaled)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="2-2-how-to-use-cbvs.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">How to load and use Cotrending Basis Vectors for Kepler, K2 and TESS</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="2-3-removing-scattered-light-using-regressioncorrector.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Removing scattered light from <em>TESS</em> light curves using linear regression (<code class="docutils literal notranslate"><span class="pre">RegressionCorrector</span></code>)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright Lightkurve developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>